<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA TRADER Pro - Gold & Stock Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        async function initApp() {
            try {
                const res = await fetch('/api/config');
                if (!res.ok) throw new Error('API_FAIL');
                const firebaseConfig = await res.json();

                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.firebaseOps = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp };
                window.dispatchEvent(new Event('firebase-ready'));
                console.log("Firebase initialized");
            } catch (e) {
                console.error(e);
                alert("‚ö†Ô∏è Á≥ªÁµ±Ë≠¶ÂëäÔºöÁÑ°Ê≥ïËÆÄÂèñË®≠ÂÆöÔºåË´ãÊ™¢Êü• API ÈÄ£Á∑ö„ÄÇ");
            }
        }
        initApp();
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter'], mono: ['JetBrains Mono'] },
                    colors: { gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' }, up: '#ef4444', down: '#22c55e', gold: '#fbbf24' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .number-font { font-family: 'JetBrains Mono', monospace; }
        [v-cloak] { display: none; }
        /* Â±ïÈñãÂãïÁï´ */
        .expand-enter-active, .expand-leave-active { transition: all 0.3s ease; max-height: 500px; opacity: 1; overflow: hidden; }
        .expand-enter-from, .expand-leave-to { max-height: 0; opacity: 0; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 h-screen overflow-hidden flex flex-col font-sans">

    <div id="app" v-cloak class="flex h-full">
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <h1 class="text-xl font-bold tracking-wider text-blue-400">ALPHA TRADER</h1>
                <p class="text-xs text-gray-500 mt-1">Multi-Asset Wallet</p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button @click="currentTab = 'dashboard'" :class="getTabClass('dashboard')" class="nav-btn">
                    üìä Á∏ΩË¶ΩÂÑÄË°®Êùø
                </button>
                <button @click="currentTab = 'holdings'" :class="getTabClass('holdings')" class="nav-btn">
                    üíº Ë≠âÂà∏Â∫´Â≠ò
                </button>
                <button @click="currentTab = 'history'" :class="getTabClass('history')" class="nav-btn">
                    üìú Â∑≤ÂØ¶ÁèæÊêçÁõä
                </button>
                <button @click="currentTab = 'gold'" :class="getTabClass('gold')" class="nav-btn text-yellow-500 hover:bg-yellow-900/20">
                    üèÜ ÈªÉÈáëÂ≠òÊë∫
                </button>
            </nav>
            <div class="p-4 border-t border-gray-800 text-xs text-gray-500 text-center">
                {{ currentTime }}
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            
            <header class="bg-gray-900/50 border-b border-gray-800 p-6 backdrop-blur-sm">
                <div v-if="currentTab === 'gold'" class="grid grid-cols-2 gap-6">
                     <div class="bg-yellow-900/20 rounded-xl p-4 border border-yellow-700/50">
                        <div class="text-yellow-500 text-xs mb-1">Â∫´Â≠òÁ∏ΩÂÖãÊï∏ (g)</div>
                        <div class="text-3xl font-bold number-font text-yellow-400">{{ formatNumber(totalGoldWeight) }} g</div>
                    </div>
                    <div class="bg-yellow-900/20 rounded-xl p-4 border border-yellow-700/50">
                        <div class="text-yellow-500 text-xs mb-1">ÈªÉÈáëÁ∏ΩÊàêÊú¨</div>
                        <div class="text-3xl font-bold number-font text-white">{{ formatCurrency(totalGoldCost) }}</div>
                    </div>
                </div>

                <div v-else class="grid grid-cols-4 gap-6">
                    <div class="stat-card">
                        <div class="text-gray-400 text-xs mb-1">Ë≠âÂà∏Á∏ΩË≥áÁî¢</div>
                        <div class="text-2xl font-bold number-font">{{ formatCurrency(totalAssets) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-gray-400 text-xs mb-1">Êú™ÂØ¶ÁèæÊêçÁõä</div>
                        <div :class="getColorClass(totalUnrealizedPL)" class="text-2xl font-bold number-font">
                            {{ formatCurrency(totalUnrealizedPL) }}
                            <span class="text-sm ml-2">({{ formatPercent(totalUnrealizedPLRate) }})</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-gray-400 text-xs mb-1">Â∑≤ÂØ¶ÁèæÊêçÁõä</div>
                        <div :class="getColorClass(totalRealizedPL)" class="text-2xl font-bold number-font">{{ formatCurrency(totalRealizedPL) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-gray-400 text-xs mb-1">Âπ¥Â∫¶Â†±ÈÖ¨Áéá</div>
                        <div :class="getColorClass(annualROI)" class="text-2xl font-bold number-font">{{ formatPercent(annualROI) }}</div>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-6 relative scroll-smooth">
                
                <div v-if="currentTab === 'dashboard' || currentTab === 'holdings'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-3">
                            <span class="w-1 h-6 bg-blue-500 rounded-full"></span> Ë≠âÂà∏Â∫´Â≠ò
                            <button @click="refreshPrices" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded border border-gray-700 transition flex items-center gap-2">
                                <span v-if="loadingPrices" class="animate-spin">‚ü≥</span>
                                <span>{{ loadingPrices ? 'Êõ¥Êñ∞‰∏≠...' : 'üîÑ ÊâãÂãïÊõ¥Êñ∞ËÇ°ÂÉπ' }}</span>
                            </button>
                        </h2>
                        <button @click="openModal('holdings')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            + Êñ∞Â¢ûÊåÅËÇ°
                        </button>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">ÂàÜÈ°û</th>
                                    <th class="px-4 py-3">ÂêçÁ®±(‰ª£Ëôü)</th>
                                    <th class="px-4 py-3 text-right">ÂùáÂÉπ</th>
                                    <th class="px-4 py-3 text-right">ÁèæÂÉπ</th>
                                    <th class="px-4 py-3 text-right">ËÇ°Êï∏</th>
                                    <th class="px-4 py-3 text-right">ÊêçÁõä</th>
                                    <th class="px-4 py-3 text-right">%</th>
                                    <th class="px-4 py-3 text-right">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <template v-for="stock in sortedHoldings" :key="stock.id">
                                    <tr @click="toggleExpand(stock.id)" class="hover:bg-gray-800/50 cursor-pointer group transition-colors">
                                        <td class="px-4 py-3">
                                            <span :class="getTypeBadge(stock.type)" class="px-2 py-0.5 rounded text-xs border font-normal">{{ stock.type }}</span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="font-bold text-white text-base">
                                                {{ stock.name }}<span class="text-gray-400 text-sm font-normal ml-1">({{ stock.code }})</span>
                                                <span v-if="expandedSet.has(stock.id)" class="text-xs text-blue-400 ml-2">‚ñº ÊòéÁ¥∞</span>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 text-right number-font text-gray-300">{{ formatPrice(stock.cost) }}</td>
                                        <td class="px-4 py-3 text-right number-font font-bold" :class="getPriceColor(stock)">{{ formatPrice(stock.currentPrice) }}</td>
                                        <td class="px-4 py-3 text-right number-font text-gray-300">{{ formatNumber(stock.volume) }}</td>
                                        <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">
                                            {{ formatCurrency(calculateUnrealizedPL(stock)) }}
                                        </td>
                                        <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">
                                            {{ formatPercent(calculateUnrealizedRate(stock)) }}
                                        </td>
                                        <td class="px-4 py-3 text-right" @click.stop>
                                            <button @click="editItem('holdings', stock)" class="text-gray-500 hover:text-blue-400 mr-3 transition">‚úé</button>
                                            <button @click="deleteItem('holdings', stock.id)" class="text-gray-500 hover:text-red-400 transition">‚úï</button>
                                        </td>
                                    </tr>
                                    <tr v-if="expandedSet.has(stock.id)" class="bg-gray-900/50 border-b border-gray-800">
                                        <td colspan="8" class="p-0">
                                            <div class="p-4 bg-gray-800/30 shadow-inner">
                                                <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">Â∫´Â≠òÊòéÁ¥∞ (Lots)</h4>
                                                <table class="w-full text-xs text-gray-300">
                                                    <thead>
                                                        <tr class="text-gray-500 border-b border-gray-700">
                                                            <th class="py-2 text-left">Ë≤∑ÈÄ≤Êó•Êúü</th>
                                                            <th class="py-2 text-right">Ë≤∑ÈÄ≤ÂÉπÊ†º</th>
                                                            <th class="py-2 text-right">ËÇ°Êï∏</th>
                                                            <th class="py-2 text-right">ÊâãÁ∫åË≤ª</th>
                                                            <th class="py-2 text-right">ÊàêÊú¨Â∞èË®à</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr v-for="(lot, idx) in (stock.lots || [])" :key="idx" class="border-b border-gray-700/50">
                                                            <td class="py-2 number-font">{{ lot.date || '---' }}</td>
                                                            <td class="py-2 text-right number-font">{{ formatPrice(lot.price) }}</td>
                                                            <td class="py-2 text-right number-font">{{ formatNumber(lot.volume) }}</td>
                                                            <td class="py-2 text-right number-font">{{ formatNumber(lot.fee) }}</td>
                                                            <td class="py-2 text-right number-font text-gray-400">{{ formatCurrency(lot.price * lot.volume + (lot.fee||0)) }}</td>
                                                        </tr>
                                                        <tr v-if="!stock.lots || stock.lots.length === 0">
                                                            <td colspan="5" class="py-3 text-center text-gray-500 italic">Ê≠§ÁÇ∫ËàäË≥áÊñôÔºåÁÑ°Ë©≥Á¥∞ÊâπÊ¨°Á¥ÄÈåÑ</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'gold'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-yellow-500 flex items-center gap-3">
                            <span class="w-1 h-6 bg-yellow-500 rounded-full"></span> ÈªÉÈáëÂ∫´Â≠òÊòéÁ¥∞
                        </h2>
                        <button @click="openModal('gold')" class="bg-yellow-600 hover:bg-yellow-500 text-black px-3 py-1.5 rounded text-sm font-bold transition">
                            + Êñ∞Â¢ûÈªÉÈáë
                        </button>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">Ë≤∑ÈÄ≤Êó•Êúü</th>
                                    <th class="px-4 py-3 text-right">ÈáçÈáè (g)</th>
                                    <th class="px-4 py-3 text-right">Á∏ΩÊàêÊú¨ (TWD)</th>
                                    <th class="px-4 py-3 text-right">Âπ≥ÂùáÂñÆÂÉπ (ÂÖÉ/g)</th>
                                    <th class="px-4 py-3 text-right">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="g in goldList" :key="g.id" class="hover:bg-gray-800/50">
                                    <td class="px-4 py-3 number-font text-gray-300">{{ g.date }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold text-yellow-400">{{ formatNumber(g.weight) }}</td>
                                    <td class="px-4 py-3 text-right number-font">{{ formatNumber(g.cost) }}</td>
                                    <td class="px-4 py-3 text-right number-font text-gray-400">{{ formatNumber(g.cost / g.weight) }}</td>
                                    <td class="px-4 py-3 text-right">
                                        <button @click="deleteItem('gold', g.id)" class="text-gray-500 hover:text-red-400 transition">‚úï</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'dashboard' || currentTab === 'history'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-3">
                            <span class="w-1 h-6 bg-purple-500 rounded-full"></span> Â∑≤ÂØ¶ÁèæÊêçÁõä
                        </h2>
                        <button @click="openModal('history')" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            + Êñ∞Â¢ûÁ¥ÄÈåÑ
                        </button>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">Êó•Êúü</th>
                                    <th class="px-4 py-3">ÂêçÁ®±(‰ª£Ëôü)</th>
                                    <th class="px-4 py-3 text-right">Áç≤Âà©</th>
                                    <th class="px-4 py-3 text-right">%</th>
                                    <th class="px-4 py-3 text-right">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="record in history" :key="record.id" class="hover:bg-gray-800/50">
                                    <td class="px-4 py-3 text-gray-400 number-font text-xs">{{ record.date }}</td>
                                    <td class="px-4 py-3">
                                        <span class="font-bold text-white">{{ record.name }}</span>
                                        <span class="text-gray-500 text-xs ml-1">({{ record.code }})</span>
                                        <span :class="getTypeBadge(record.type)" class="ml-2 text-[10px] px-1 rounded border">{{ record.type }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(record.netPL)">{{ formatCurrency(record.netPL) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(record.netPL)">{{ formatPercent(record.roi) }}</td>
                                    <td class="px-4 py-3 text-right">
                                        <button @click="editItem('history', record)" class="text-gray-500 hover:text-blue-400 mr-3">‚úé</button>
                                        <button @click="deleteItem('history', record.id)" class="text-gray-500 hover:text-red-400">‚úï</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <transition name="modal">
                <div v-if="showModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                    <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-96 shadow-2xl">
                        <h3 class="text-lg font-bold mb-4 text-white">
                            {{ modalMode === 'add' ? 'Êñ∞Â¢û' : 'Á∑®ËºØ' }} 
                            {{ modalType === 'holdings' ? 'Â∫´Â≠ò' : (modalType === 'gold' ? 'ÈªÉÈáë' : 'Á¥ÄÈåÑ') }}
                        </h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-gray-400">Ë≤∑ÈÄ≤Êó•Êúü</label>
                                <input v-model="formData.date" type="date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none focus:border-blue-500">
                            </div>

                            <div v-if="modalType === 'gold'" class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="text-xs text-gray-400">ÈáçÈáè (ÂÖã)</label><input v-model.number="formData.weight" type="number" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none"></div>
                                    <div><label class="text-xs text-gray-400">Á∏ΩÊàêÊú¨ (ÂÖÉ)</label><input v-model.number="formData.cost" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none"></div>
                                </div>
                            </div>

                            <div v-else class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-400">‰ª£Ëôü</label>
                                        <div class="flex gap-1">
                                            <input v-model="formData.code" @blur="fetchStockName" type="text" placeholder="2330" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white uppercase outline-none">
                                            <button @click="fetchStockName" class="bg-gray-700 px-2 rounded text-xs text-white">üîç</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">ÂêçÁ®±</label>
                                        <input v-model="formData.name" type="text" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none">
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs text-gray-400">ÂàÜÈ°û</label>
                                    <select v-model="formData.type" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none">
                                        <option v-for="t in types" :value="t">{{ t }}</option>
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-400">{{ modalType === 'holdings' ? 'Ë≤∑ÈÄ≤ÂñÆÂÉπ' : 'Êàê‰∫§ÂÉπ' }}</label>
                                        <input v-model.number="formData.price" type="number" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">ËÇ°Êï∏</label>
                                        <input v-model.number="formData.volume" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none">
                                    </div>
                                </div>
                                
                                <div v-if="modalType === 'holdings' || modalType === 'history'" class="grid grid-cols-2 gap-2">
                                     <div>
                                        <label class="text-xs text-gray-400">ÊâãÁ∫åË≤ª</label>
                                        <input v-model.number="formData.fee" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none" placeholder="È†êË®≠ 0.1425%">
                                    </div>
                                    <div v-if="modalType === 'history'">
                                         <label class="text-xs text-gray-400">‰∫§ÊòìÁ®Ö</label>
                                         <input v-model.number="formData.tax" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none">
                                    </div>
                                </div>

                                <div v-if="modalType === 'history'" class="pt-2 border-t border-gray-800 grid grid-cols-2 gap-2">
                                    <div><label class="text-xs text-gray-400">Ê∑®ÊêçÁõä</label><input v-model.number="formData.netPL" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white font-bold"></div>
                                    <div><label class="text-xs text-gray-400">Â†±ÈÖ¨Áéá</label><input v-model.number="formData.roi" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                                </div>
                                
                                <button v-if="modalType === 'history'" @click="autoCalculate" class="w-full text-xs text-blue-400 border border-blue-900 rounded py-1 hover:bg-blue-900/30">‚ö° Ë≥£Âá∫Ë©¶ÁÆó</button>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button @click="saveData" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold text-sm transition">ÂÑ≤Â≠ò</button>
                            <button @click="showModal = false" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-bold text-sm transition">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>
            </transition>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const currentTab = ref('holdings');
                const currentTime = ref('');
                const loadingPrices = ref(false);
                const fetchingName = ref(false);
                const types = ['ÁèæËÇ°', 'ËûçË≥á', 'ËûçÂà∏', 'Áï∂Ê≤ñ', 'ÊúüË≤®', 'ÂÆöÊúüÂÆöÈ°ç', 'ÂÄüÂà∏'];
                
                // Data Refs
                const holdings = ref([]);
                const history = ref([]);
                const goldList = ref([]); // Êñ∞Â¢ûÈªÉÈáëÂàóË°®
                const expandedSet = ref(new Set()); // Á¥ÄÈåÑÂ±ïÈñãÁöÑ rows

                const showModal = ref(false);
                const modalMode = ref('add');
                const modalType = ref('holdings');
                const editingId = ref(null);
                const formData = ref({});

                // Firebase Sync
                const initFirebaseSync = () => {
                    const { onSnapshot, collection, query, orderBy } = window.firebaseOps;
                    if(!window.db) return;
                    // ËÇ°Á•®
                    onSnapshot(collection(window.db, "holdings"), (s) => holdings.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                    onSnapshot(query(collection(window.db, "history"), orderBy("date", "desc")), (s) => history.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                    // ÈªÉÈáë
                    onSnapshot(query(collection(window.db, "gold"), orderBy("date", "desc")), (s) => goldList.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                };

                // Helper: Ê≠£Ë¶èÂåñÂ≠ó‰∏≤ (ÂéªÈô§Á©∫ÁôΩ„ÄÅÂ§ßÂØ´)
                const normalize = (str) => String(str || '').trim().toUpperCase().replace(/\.TW(O)?$/,'');

                // Â±ïÈñã/Êî∂Âêà ÊòéÁ¥∞
                const toggleExpand = (id) => {
                    if (expandedSet.value.has(id)) expandedSet.value.delete(id);
                    else expandedSet.value.add(id);
                };

                // ÊéíÂ∫èÂæåÁöÑÂ∫´Â≠ò (ÂçáÂÜ™‰ª£Ëôü)
                const sortedHoldings = computed(() => {
                    return [...holdings.value].sort((a, b) => normalize(a.code).localeCompare(normalize(b.code)));
                });

                // ÈªÉÈáëË®àÁÆó
                const totalGoldWeight = computed(() => goldList.value.reduce((a, b) => a + (b.weight || 0), 0));
                const totalGoldCost = computed(() => goldList.value.reduce((a, b) => a + (b.cost || 0), 0));

                // ÂÑ≤Â≠òÈÇèËºØ (ÂåÖÂê´Ë§áÈõúÁöÑ Stock Âêà‰Ωµ + Lot Á¥ÄÈåÑ)
                const saveData = async () => {
                    const { addDoc, updateDoc, collection, doc } = window.firebaseOps;
                    const colName = modalType.value;
                    let data = { ...formData.value };

                    // 1. ÈªÉÈáëÈÇèËºØ
                    if (colName === 'gold') {
                        data.weight = Number(data.weight)||0;
                        data.cost = Number(data.cost)||0;
                        if(modalMode.value === 'add') await addDoc(collection(window.db, 'gold'), data);
                        else await updateDoc(doc(window.db, 'gold', editingId.value), data);
                        showModal.value = false;
                        return;
                    }

                    // 2. ËÇ°Á•®ÈÇèËºØ
                    data.price = Number(data.price) || 0;
                    data.volume = Number(data.volume) || 0;
                    data.fee = Number(data.fee); 
                    // Â¶ÇÊûúÁî®Êà∂Ê≤íÂ°´ÊâãÁ∫åË≤ªÔºåÂπ´‰ªñÁÆó‰∏ÄÂÄã (0.1425%)
                    if (isNaN(data.fee) && data.price && data.volume) {
                        data.fee = Math.floor(data.price * data.volume * 0.001425);
                    }

                    data.code = normalize(data.code);
                    if (!data.name) data.name = data.code;

                    if (colName === 'holdings') {
                        // Ê∫ñÂÇô‰∏ÄÂÄã "Lot" (ÊâπÊ¨°Á¥ÄÈåÑ)
                        const newLot = {
                            date: data.date,
                            price: data.price,
                            volume: data.volume,
                            fee: data.fee
                        };

                        if (modalMode.value === 'add') {
                            const inputCode = normalize(data.code);
                            const inputType = normalize(data.type);
                            
                            // Â∞ãÊâæÊòØÂê¶Â∑≤Â≠òÂú®
                            const existing = holdings.value.find(h => normalize(h.code) === inputCode && normalize(h.type) === inputType);

                            if (existing) {
                                // Âêà‰ΩµÈÇèËºØ
                                const oldVol = Number(existing.volume);
                                const newVol = Number(data.volume);
                                // Âä†Ê¨äÂπ≥ÂùáÊàêÊú¨
                                const avgCost = ((Number(existing.cost) * oldVol) + (data.price * newVol)) / (oldVol + newVol);
                                
                                // Êõ¥Êñ∞ lots Èô£Âàó (Â¶ÇÊûúËàäË≥áÊñôÊ≤íÊúâ lotsÔºåÂ∞±Áµ¶Á©∫Èô£Âàó)
                                const updatedLots = [...(existing.lots || []), newLot];

                                await updateDoc(doc(window.db, colName, existing.id), { 
                                    volume: oldVol + newVol, 
                                    cost: avgCost, 
                                    lots: updatedLots // Êõ¥Êñ∞ÊâπÊ¨°Á¥ÄÈåÑ
                                });
                            } else {
                                // Êñ∞Â¢ûÈÇèËºØ
                                data.cost = data.price; // ÂàùÂßãÊàêÊú¨ = Ë≤∑ÂÉπ
                                data.currentPrice = data.price; // È†êË®≠ÁèæÂÉπ
                                data.lots = [newLot]; // ÂàùÂßãÂåñ lots
                                delete data.price; // ‰∏ªÊ™îÂè™Â≠ò cost (ÂùáÂÉπ)
                                await addDoc(collection(window.db, colName), data);
                            }
                        } else {
                            // Á∑®ËºØÊ®°Âºè (ÈÄôË£°Á∞°ÂåñÔºå‰∏çËôïÁêÜ lot ÊãÜÂàÜÔºåÂè™Êîπ‰∏ªÊ™î)
                            await updateDoc(doc(window.db, colName, editingId.value), data);
                        }
                    } else {
                        // History
                        data.tax = Number(data.tax)||0; data.netPL = Number(data.netPL)||0; data.roi = Number(data.roi)||0;
                        if(modalMode.value === 'add') await addDoc(collection(window.db, colName), data);
                        else await updateDoc(doc(window.db, colName, editingId.value), data);
                    }
                    showModal.value = false;
                };

                // API Êõ¥Êñ∞ËÇ°ÂÉπ (ÊâãÂãï)
                const refreshPrices = async () => {
                    loadingPrices.value = true;
                    const symbols = [...new Set(holdings.value.map(h => h.code))];
                    if(symbols.length === 0) { loadingPrices.value = false; return; }
                    try {
                        const res = await fetch(`/api/quote?symbols=${symbols.join(',')}`);
                        if(!res.ok) throw new Error('API Error');
                        const data = await res.json();
                        const { updateDoc, doc } = window.firebaseOps;
                        for (const stock of holdings.value) {
                            const key = normalize(stock.code);
                            const stockData = data[key] || data[`${key}.TW`]; 
                            if (stockData && stockData.price) {
                                await updateDoc(doc(window.db, "holdings", stock.id), { currentPrice: stockData.price, name: stockData.name || stock.name });
                            }
                        }
                    } catch (e) { alert("Êõ¥Êñ∞Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑Ø"); }
                    loadingPrices.value = false;
                };

                // ÊäìÂèñÂêçÁ®±
                const fetchStockName = async () => {
                    const code = formData.value.code;
                    if (!code || code.length < 3) return;
                    fetchingName.value = true;
                    try {
                        const res = await fetch(`/api/quote?symbols=${code}`);
                        const data = await res.json();
                        const key = normalize(code);
                        const stockData = data[key] || data[`${key}.TW`]; 
                        if (stockData && stockData.name) {
                            formData.value.name = stockData.name;
                            if (modalMode.value === 'add' && !formData.value.price && modalType.value !== 'gold') formData.value.price = stockData.price;
                        }
                    } catch (e) { console.error(e); }
                    fetchingName.value = false;
                };

                // UI Helpers
                const openModal = (type) => { 
                    modalType.value = type; modalMode.value = 'add'; 
                    formData.value = { date: new Date().toISOString().split('T')[0], type: 'ÁèæËÇ°', price: 0, volume: 1000, weight: 0, cost: 0 }; 
                    showModal.value = true; 
                };
                const editItem = (type, item) => { 
                    modalType.value = type; modalMode.value = 'edit'; editingId.value = item.id; 
                    formData.value = { ...item }; 
                    if(type==='holdings') formData.value.price = item.cost; 
                    showModal.value = true; 
                };
                const deleteItem = async (type, id) => { if(confirm('Á¢∫ÂÆöÂà™Èô§?')) await window.firebaseOps.deleteDoc(window.firebaseOps.doc(window.db, type, id)); };
                const getTabClass = (tab) => currentTab.value === tab ? 'bg-gray-800 text-white shadow' : 'text-gray-400 hover:bg-gray-800/50';
                
                // Formatters (Price Â∞èÊï∏Èªû 2 ‰Ωç)
                const formatCurrency = (v) => new Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD', minimumFractionDigits:0}).format(v||0);
                const formatNumber = (v) => new Intl.NumberFormat('zh-TW').format(v||0);
                const formatPrice = (v) => new Intl.NumberFormat('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v||0);
                const formatPercent = (v) => ((v||0) * 100).toFixed(2) + '%';
                const getColorClass = (v) => v > 0 ? 'text-up' : (v < 0 ? 'text-down' : 'text-gray-400');
                const getPriceColor = (s) => s.currentPrice > s.cost ? 'text-up' : (s.currentPrice < s.cost ? 'text-down' : 'text-white');
                const getTypeBadge = (t) => { const m = {'ÁèæËÇ°':'border-blue-800 text-blue-400', 'ËûçË≥á':'border-orange-800 text-orange-400', 'ÊúüË≤®':'border-red-800 text-red-400'}; return m[t] ? `bg-${m[t].split(' ')[0].replace('border-','')} ${m[t]}` : 'bg-gray-800 text-gray-300'; };
                
                // Computed logic for Stock
                const calculateUnrealizedPL = (s) => (s.currentPrice * s.volume) - (s.cost * s.volume);
                const calculateUnrealizedRate = (s) => s.cost ? (s.currentPrice - s.cost) / s.cost : 0;
                const totalAssets = computed(() => holdings.value.reduce((a, b) => a + (b.currentPrice * b.volume), 0));
                const totalUnrealizedPL = computed(() => holdings.value.reduce((a, b) => a + calculateUnrealizedPL(b), 0));
                const totalUnrealizedPLRate = computed(() => { const cost = holdings.value.reduce((a, b) => a + (b.cost * b.volume), 0); return cost ? totalUnrealizedPL.value / cost : 0; });
                const totalRealizedPL = computed(() => history.value.reduce((a, b) => a + (b.netPL||0), 0));
                const annualROI = computed(() => totalRealizedPL.value / 5000000); // ÂÅáË®≠Êú¨Èáë
                
                // History auto calc
                const autoCalculate = () => { const p=formData.value.price, v=formData.value.volume; formData.value.fee=Math.floor(p*v*0.001425); formData.value.tax=Math.floor(p*v*0.003); };

                onMounted(() => {
                    window.addEventListener('firebase-ready', () => { initFirebaseSync(); });
                    if (window.db) initFirebaseSync();
                    setInterval(() => currentTime.value = new Date().toLocaleString('zh-TW', {hour12:false}), 1000);
                });

                return { 
                    currentTab, currentTime, holdings, sortedHoldings, history, goldList, showModal, modalMode, modalType, formData, types, 
                    totalAssets, totalUnrealizedPL, totalUnrealizedPLRate, totalRealizedPL, annualROI, loadingPrices, fetchingName, expandedSet,
                    totalGoldWeight, totalGoldCost,
                    openModal, editItem, deleteItem, saveData, refreshPrices, fetchStockName, toggleExpand, autoCalculate, getTabClass,
                    formatCurrency, formatNumber, formatPrice, formatPercent, getColorClass, getPriceColor, getTypeBadge, calculateUnrealizedPL, calculateUnrealizedRate 
                };
            }
        }).mount('#app');
    </script>
    <style>
        .nav-btn { @apply w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center mb-1; }
        .stat-card { @apply bg-gray-800/50 rounded-xl p-4 border border-gray-700; }
    </style>
</body>
</html>