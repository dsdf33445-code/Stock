<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA TRADER Pro - Ultimate V7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        async function initApp() {
            try {
                const res = await fetch('/api/config');
                if (!res.ok) throw new Error('API_FAIL');
                const firebaseConfig = await res.json();

                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.firebaseOps = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp };
                window.dispatchEvent(new Event('firebase-ready'));
                console.log("Firebase initialized");
            } catch (e) {
                console.error(e);
            }
        }
        initApp();
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter'], mono: ['JetBrains Mono'] },
                    colors: { gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' }, up: '#ef4444', down: '#22c55e', gold: '#fbbf24', us: '#3b82f6' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        .number-font { font-family: 'JetBrains Mono', monospace; }
        [v-cloak] { display: none; }
        .nav-btn { @apply w-full text-left px-6 py-4 rounded-xl text-lg font-bold transition-all flex items-center mb-2 whitespace-nowrap; }
        
        /* è¡¨æ ¼åŸºç¤æ¨£å¼ (å¼·åˆ¶ä¸æ›è¡Œ) */
        th, td { white-space: nowrap; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 h-screen overflow-hidden flex flex-col font-sans">

    <div id="app" v-cloak class="flex h-full">
        <aside class="w-72 bg-gray-900 border-r border-gray-800 flex flex-col flex-shrink-0">
            <div class="p-8 border-b border-gray-800">
                <h1 class="text-2xl font-black tracking-wider text-blue-500">ALPHA TRADER</h1>
                <p class="text-sm text-gray-500 mt-2 font-medium">Global Asset Manager</p>
            </div>
            <nav class="flex-1 p-6 flex flex-col gap-2 overflow-y-auto">
                <button @click="switchTab('dashboard')" :class="getTabClass('dashboard')" class="nav-btn">
                    <span class="w-8 mr-3 text-xl">ğŸ“Š</span> ç¸½è¦½å„€è¡¨æ¿
                </button>
                <button @click="switchTab('holdings')" :class="getTabClass('holdings')" class="nav-btn">
                    <span class="w-8 mr-3 text-xl">ğŸ’¼</span> å°è‚¡åº«å­˜
                </button>
                <button @click="switchTab('us_stocks')" :class="getTabClass('us_stocks')" class="nav-btn hover:bg-blue-900/20">
                    <span class="w-8 mr-3 text-xl">ğŸ‡ºğŸ‡¸</span> ç¾è‚¡é…ç½®
                </button>
                <button @click="switchTab('gold')" :class="getTabClass('gold')" class="nav-btn text-yellow-500 hover:bg-yellow-900/20">
                    <span class="w-8 mr-3 text-xl">ğŸ†</span> é»ƒé‡‘å­˜æ‘º
                </button>
                <button @click="switchTab('history', 'all')" :class="getTabClass('history')" class="nav-btn">
                    <span class="w-8 mr-3 text-xl">ğŸ“œ</span> å·²å¯¦ç¾æç›Š
                </button>
            </nav>
            <div class="p-6 border-t border-gray-800 text-sm text-gray-500 text-center font-mono">
                {{ currentTime }}
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            
            <header class="bg-gray-900/50 border-b border-gray-800 p-6 backdrop-blur-sm flex-shrink-0">
                
                <div v-if="currentTab === 'dashboard'" class="grid grid-cols-4 gap-6">
                    <div class="bg-gradient-to-br from-indigo-600 to-indigo-900 rounded-2xl p-5 shadow-lg relative overflow-hidden group border border-indigo-500/30">
                        <div class="absolute right-0 top-0 p-4 opacity-20 text-6xl">ğŸŒ</div>
                        <div class="text-indigo-100 text-sm font-bold mb-1">å…¨çƒæ·¨è³‡ç”¢ (TWD)</div>
                        <div class="text-3xl font-black number-font text-white">{{ formatCurrency(grandTotalAssets) }}</div>
                    </div>
                    <div class="bg-gray-800 rounded-2xl p-5 border border-gray-700 shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-gray-400 text-xs font-bold mb-1">å°è‚¡ç¸½å€¼</div>
                                <div class="text-xl font-bold number-font text-white">{{ formatCurrency(totalAssets) }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 mb-1">æç›Š</div>
                                <div class="text-sm font-bold number-font" :class="getColorClass(totalUnrealizedPL)">{{ formatCurrency(totalUnrealizedPL) }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 rounded-2xl p-5 border border-blue-900/50 shadow-md relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-2 opacity-10 text-4xl text-blue-500">ğŸ‡ºğŸ‡¸</div>
                        <div class="flex justify-between items-start relative z-10">
                            <div>
                                <div class="text-blue-400 text-xs font-bold mb-1">ç¾è‚¡ç¸½å€¼ (USD)</div>
                                <div class="text-xl font-bold number-font text-white">$ {{ formatPrice(totalUSAssets) }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 mb-1">æç›Š</div>
                                <div class="text-sm font-bold number-font" :class="getColorClass(totalUSUnrealizedPL)">$ {{ formatPrice(totalUSUnrealizedPL) }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 rounded-2xl p-5 border border-yellow-900/50 shadow-md relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-2 opacity-10 text-4xl text-yellow-500">ğŸ†</div>
                        <div class="flex justify-between items-start relative z-10">
                            <div>
                                <div class="text-yellow-500 text-xs font-bold mb-1">é»ƒé‡‘ç¸½å€¼ (Est.)</div>
                                <div class="text-xl font-bold number-font text-yellow-400">{{ formatCurrency(totalGoldCost) }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 mb-1">åº«å­˜</div>
                                <div class="text-sm font-bold number-font text-yellow-600">{{ formatNumber(totalGoldWeight) }}g</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentTab === 'gold'" class="grid grid-cols-2 gap-6">
                     <div class="bg-gray-800 rounded-2xl p-6 border border-yellow-700/50 flex items-center justify-between shadow-lg">
                        <div>
                            <div class="text-yellow-500 text-sm font-bold mb-1">åº«å­˜ç¸½å…‹æ•¸</div>
                            <div class="text-4xl font-bold number-font text-yellow-400">{{ formatNumber(totalGoldWeight) }} <span class="text-lg">g</span></div>
                        </div>
                        <div class="text-6xl opacity-20">âš–ï¸</div>
                    </div>
                    <div class="bg-gray-800 rounded-2xl p-6 border border-yellow-700/50 flex items-center justify-between shadow-lg">
                        <div>
                            <div class="text-yellow-500 text-sm font-bold mb-1">æŠ•å…¥ç¸½æˆæœ¬</div>
                            <div class="text-4xl font-bold number-font text-white">{{ formatCurrency(totalGoldCost) }}</div>
                        </div>
                        <div class="text-6xl opacity-20">ğŸ’°</div>
                    </div>
                </div>

                <div v-else class="grid grid-cols-4 gap-6">
                     <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                         <div class="text-gray-400 text-xs">ç¸½è³‡ç”¢</div>
                         <div class="text-2xl font-bold number-font text-white">{{ currentTab==='us_stocks' ? '$ '+formatPrice(totalUSAssets) : formatCurrency(totalAssets) }}</div>
                     </div>
                     <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                         <div class="text-gray-400 text-xs">æœªå¯¦ç¾æç›Š</div>
                         <div class="text-2xl font-bold number-font" :class="getColorClass(currentTab==='us_stocks'?totalUSUnrealizedPL:totalUnrealizedPL)">
                             {{ currentTab==='us_stocks'?'$ '+formatPrice(totalUSUnrealizedPL):formatCurrency(totalUnrealizedPL) }}
                         </div>
                     </div>
                     <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                         <div class="text-gray-400 text-xs">å·²å¯¦ç¾æç›Š</div>
                         <div class="text-2xl font-bold number-font" :class="getColorClass(currentTab==='us_stocks'?totalUsRealizedPL:totalTwRealizedPL)">
                             {{ currentTab==='us_stocks'?'$ '+formatPrice(totalUsRealizedPL):formatCurrency(totalTwRealizedPL) }}
                         </div>
                     </div>
                     <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                         <div class="text-gray-400 text-xs">å ±é…¬ç‡</div>
                         <div class="text-2xl font-bold number-font" :class="getColorClass(currentTab==='us_stocks'?totalUSUnrealizedRate:annualROI)">
                             {{ formatPercent(currentTab==='us_stocks'?totalUSUnrealizedRate:annualROI) }}
                         </div>
                     </div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-6 relative scroll-smooth">
                
                <div v-if="currentTab === 'dashboard'" class="space-y-8">
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-white flex items-center"><span class="w-1 h-6 bg-blue-500 rounded-full mr-3"></span> å°è‚¡åº«å­˜æ¦‚è¦½</h3>
                            <button @click="switchTab('holdings')" class="text-xs text-blue-400 hover:text-blue-300">å‰å¾€å°è‚¡ ></button>
                        </div>
                        <div class="bg-gray-900 border border-gray-800 rounded-xl shadow-xl overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                    <tr>
                                        <th class="px-6 py-4 text-center">ä»£è™Ÿ</th>
                                        <th class="px-6 py-4 text-center">åç¨±</th>
                                        <th class="px-6 py-4 text-center">ç¾åƒ¹</th>
                                        <th class="px-6 py-4 text-center">å‡åƒ¹(æˆæœ¬)</th>
                                        <th class="px-6 py-4 text-center">æç›Š</th>
                                        <th class="px-6 py-4 text-center">%</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">
                                    <tr v-for="stock in sortedHoldings.slice(0, 5)" :key="stock.id" class="hover:bg-gray-800/50">
                                        <td class="px-6 py-4 text-center font-bold">{{ stock.code }}</td>
                                        <td class="px-6 py-4 text-center text-gray-300">{{ stock.name }}</td>
                                        <td class="px-6 py-4 text-center number-font" :class="getPriceColor(stock)">{{ formatPrice(stock.currentPrice) }}</td>
                                        <td class="px-6 py-4 text-center number-font text-gray-500">{{ formatPrice(stock.cost) }}</td>
                                        <td class="px-6 py-4 text-center number-font" :class="getColorClass(calculateUnrealizedPL(stock))">{{ formatCurrency(calculateUnrealizedPL(stock)) }}</td>
                                        <td class="px-6 py-4 text-center number-font" :class="getColorClass(calculateUnrealizedPL(stock))">{{ formatPercent(calculateUnrealizedRate(stock)) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-white flex items-center"><span class="w-1 h-6 bg-blue-600 rounded-full mr-3"></span> ç¾è‚¡åº«å­˜æ¦‚è¦½</h3>
                            <button @click="switchTab('us_stocks')" class="text-xs text-blue-400 hover:text-blue-300">å‰å¾€ç¾è‚¡ ></button>
                        </div>
                        <div class="bg-gray-900 border border-gray-800 rounded-xl shadow-xl overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                    <tr>
                                        <th class="px-6 py-4 text-center">ä»£è™Ÿ</th>
                                        <th class="px-6 py-4 text-center">åç¨±</th>
                                        <th class="px-6 py-4 text-center">ç¾åƒ¹(USD)</th>
                                        <th class="px-6 py-4 text-center">å‡åƒ¹(æˆæœ¬)</th>
                                        <th class="px-6 py-4 text-center">æç›Š(USD)</th>
                                        <th class="px-6 py-4 text-center">%</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">
                                    <tr v-for="stock in usHoldings.slice(0, 5)" :key="stock.id" class="hover:bg-gray-800/50">
                                        <td class="px-6 py-4 text-center font-bold text-blue-400">{{ stock.code }}</td>
                                        <td class="px-6 py-4 text-center text-gray-300">{{ stock.name }}</td>
                                        <td class="px-6 py-4 text-center number-font" :class="getPriceColor(stock)">{{ formatPrice(stock.currentPrice) }}</td>
                                        <td class="px-6 py-4 text-center number-font text-gray-500">{{ formatPrice(stock.cost) }}</td>
                                        <td class="px-6 py-4 text-center number-font" :class="getColorClass(calculateUnrealizedPL(stock))">$ {{ formatPrice(calculateUnrealizedPL(stock)) }}</td>
                                        <td class="px-6 py-4 text-center number-font" :class="getColorClass(calculateUnrealizedPL(stock))">{{ formatPercent(calculateUnrealizedRate(stock)) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'holdings'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex gap-2">
                            <h2 class="text-lg font-bold text-white flex items-center gap-2"><span class="w-1 h-6 bg-blue-500 rounded-full"></span> å°è‚¡åº«å­˜</h2>
                            <button @click="switchTab('history', 'tw')" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs border border-gray-600 transition">ğŸ“œ å°è‚¡å·²å¯¦ç¾</button>
                        </div>
                        <div class="flex gap-2">
                            <button @click="refreshPrices('tw')" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded border border-gray-700 transition flex items-center gap-2">
                                <span v-if="loadingPrices" class="animate-spin">âŸ³</span><span>æ›´æ–°è‚¡åƒ¹</span>
                            </button>
                            <button @click="openModal('holdings')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">+ æ–°å¢å°è‚¡</button>
                        </div>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl shadow-xl overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-6 py-4 text-center">åˆ†é¡</th>
                                    <th class="px-6 py-4 text-center">åç¨±(ä»£è™Ÿ)</th>
                                    <th class="px-6 py-4 text-center">å‡åƒ¹</th>
                                    <th class="px-6 py-4 text-center">ç¾åƒ¹</th>
                                    <th class="px-6 py-4 text-center">è‚¡æ•¸</th>
                                    <th class="px-6 py-4 text-center">æç›Š</th>
                                    <th class="px-6 py-4 text-center">%</th>
                                    <th class="px-6 py-4 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <template v-for="stock in sortedHoldings" :key="stock.id">
                                    <tr @click="toggleExpand(stock.id)" class="hover:bg-gray-800/50 cursor-pointer group">
                                        <td class="px-6 py-4 text-center"><span :class="getTypeBadge(stock.type)" class="px-2 py-0.5 rounded text-xs border font-normal">{{ stock.type }}</span></td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="font-bold text-white text-base">{{ stock.name }} <span class="text-gray-400 text-xs">({{ stock.code }})</span></div>
                                            <div v-if="expandedSet.has(stock.id)" class="text-[10px] text-blue-400 mt-1">â–¼ æ˜ç´°</div>
                                        </td>
                                        <td class="px-6 py-4 text-center number-font text-gray-300">{{ formatPrice(stock.cost) }}</td>
                                        <td class="px-6 py-4 text-center number-font font-bold" :class="getPriceColor(stock)">{{ formatPrice(stock.currentPrice) }}</td>
                                        <td class="px-6 py-4 text-center number-font">{{ formatNumber(stock.volume) }}</td>
                                        <td class="px-6 py-4 text-center number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">{{ formatCurrency(calculateUnrealizedPL(stock)) }}</td>
                                        <td class="px-6 py-4 text-center number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">{{ formatPercent(calculateUnrealizedRate(stock)) }}</td>
                                        <td class="px-6 py-4 text-center" @click.stop>
                                            <button @click="openSellModal(stock)" class="bg-red-900/30 text-red-400 px-2 py-1 rounded text-xs mr-2 border border-red-900 hover:bg-red-900/50">è³£å‡º</button>
                                            <button @click="editItem('holdings', stock)" class="text-gray-500 hover:text-blue-400 mr-2 text-lg">âœ</button>
                                            <button @click="confirmDelete('holdings', stock.id)" class="text-gray-500 hover:text-red-400 text-lg">âœ•</button>
                                        </td>
                                    </tr>
                                    <tr v-if="expandedSet.has(stock.id)" class="bg-gray-900/50 border-b border-gray-800"><td colspan="8" class="p-4"><div class="bg-gray-800/30 p-2 rounded border border-gray-700/50"><table class="w-full text-xs text-gray-300"><thead><tr><th class="text-center py-2">æ—¥æœŸ</th><th class="text-center py-2">è²·åƒ¹</th><th class="text-center py-2">è‚¡æ•¸</th><th class="text-center py-2">æ‰‹çºŒè²»</th><th class="text-center py-2">æ“ä½œ</th></tr></thead><tbody><tr v-for="(l,i) in stock.lots" :key="i"><td class="text-center py-2">{{l.date}}</td><td class="text-center py-2">{{formatPrice(l.price)}}</td><td class="text-center py-2">{{formatNumber(l.volume)}}</td><td class="text-center py-2">{{l.fee}}</td><td class="text-center py-2"><button @click="openEditLotModal(stock,i)" class="text-blue-400 mr-3">âœ</button><button @click="deleteLot(stock,i)" class="text-red-400">âœ•</button></td></tr></tbody></table></div></td></tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'us_stocks'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex gap-2">
                            <h2 class="text-lg font-bold text-white flex items-center gap-2"><span class="w-1 h-6 bg-blue-600 rounded-full"></span> ç¾è‚¡é…ç½®</h2>
                            <button @click="switchTab('history', 'us')" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs border border-gray-600 transition">ğŸ“œ ç¾è‚¡å·²å¯¦ç¾</button>
                        </div>
                        <div class="flex gap-2">
                            <button @click="refreshPrices('us')" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded border border-gray-700 transition flex items-center gap-2">
                                <span v-if="loadingPrices" class="animate-spin">âŸ³</span><span>æ›´æ–°ç¾è‚¡</span>
                            </button>
                            <button @click="openModal('us_stocks')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">+ æ–°å¢ç¾è‚¡</button>
                        </div>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl shadow-xl overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-6 py-4 text-center">ä»£è™Ÿ</th>
                                    <th class="px-6 py-4 text-center">åç¨±</th>
                                    <th class="px-6 py-4 text-center">å‡åƒ¹(USD)</th>
                                    <th class="px-6 py-4 text-center">ç¾åƒ¹(USD)</th>
                                    <th class="px-6 py-4 text-center">è‚¡æ•¸</th>
                                    <th class="px-6 py-4 text-center">æç›Š(USD)</th>
                                    <th class="px-6 py-4 text-center">%</th>
                                    <th class="px-6 py-4 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <template v-for="stock in usHoldings" :key="stock.id">
                                    <tr @click="toggleExpand(stock.id)" class="hover:bg-gray-800/50 cursor-pointer group">
                                        <td class="px-6 py-4 text-center font-bold text-blue-400">{{ stock.code }}</td>
                                        <td class="px-6 py-4 text-center text-gray-300">{{ stock.name }}</td>
                                        <td class="px-6 py-4 text-center number-font text-gray-300">{{ formatPrice(stock.cost) }}</td>
                                        <td class="px-6 py-4 text-center number-font font-bold" :class="getPriceColor(stock)">{{ formatPrice(stock.currentPrice) }}</td>
                                        <td class="px-6 py-4 text-center number-font">{{ formatNumber(stock.volume) }}</td>
                                        <td class="px-6 py-4 text-center number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">$ {{ formatPrice(calculateUnrealizedPL(stock)) }}</td>
                                        <td class="px-6 py-4 text-center number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">{{ formatPercent(calculateUnrealizedRate(stock)) }}</td>
                                        <td class="px-6 py-4 text-center" @click.stop>
                                            <button @click="openSellModal(stock)" class="bg-red-900/30 text-red-400 px-2 py-1 rounded text-xs mr-2 border border-red-900">è³£å‡º</button>
                                            <button @click="editItem('us_stocks', stock)" class="text-gray-500 hover:text-blue-400 mr-2 text-lg">âœ</button>
                                            <button @click="confirmDelete('us_stocks', stock.id)" class="text-gray-500 hover:text-red-400 text-lg">âœ•</button>
                                        </td>
                                    </tr>
                                    <tr v-if="expandedSet.has(stock.id)" class="bg-gray-900/50 border-b border-gray-800"><td colspan="8" class="p-4"><div class="bg-gray-800/30 p-2"><table class="w-full text-xs text-gray-300"><thead><tr><th class="text-center py-2">æ—¥æœŸ</th><th class="text-center py-2">è²·åƒ¹</th><th class="text-center py-2">è‚¡æ•¸</th><th class="text-center py-2">æ“ä½œ</th></tr></thead><tbody><tr v-for="(l,i) in stock.lots" :key="i"><td class="text-center py-2">{{l.date}}</td><td class="text-center py-2">{{formatPrice(l.price)}}</td><td class="text-center py-2">{{formatNumber(l.volume)}}</td><td class="text-center py-2"><button @click="openEditLotModal(stock,i)" class="text-blue-400 mr-2">âœ</button><button @click="deleteLot(stock,i)" class="text-red-400">âœ•</button></td></tr></tbody></table></div></td></tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'gold'" class="mb-10">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold text-yellow-500">é»ƒé‡‘åº«å­˜</h2><button @click="openModal('gold')" class="bg-yellow-600 text-black px-3 py-1.5 rounded text-sm font-bold">+ æ–°å¢é»ƒé‡‘</button></div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl shadow-xl overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-6 py-4 text-center">æ—¥æœŸ</th>
                                    <th class="px-6 py-4 text-center">é‡é‡</th>
                                    <th class="px-6 py-4 text-center">æˆæœ¬</th>
                                    <th class="px-6 py-4 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="g in goldList" :key="g.id">
                                    <td class="px-6 py-4 text-center">{{g.date}}</td>
                                    <td class="px-6 py-4 text-center text-yellow-400">{{g.weight}}g</td>
                                    <td class="px-6 py-4 text-center">{{formatNumber(g.cost)}}</td>
                                    <td class="px-6 py-4 text-center"><button @click="confirmDelete('gold',g.id)" class="text-red-400">âœ•</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'history'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex gap-2">
                            <button @click="historyFilter='all'" :class="historyFilter==='all'?'bg-blue-600 text-white':'bg-gray-800 text-gray-400'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition">å…¨éƒ¨</button>
                            <button @click="historyFilter='tw'" :class="historyFilter==='tw'?'bg-blue-600 text-white':'bg-gray-800 text-gray-400'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition">å°è‚¡</button>
                            <button @click="historyFilter='us'" :class="historyFilter==='us'?'bg-blue-600 text-white':'bg-gray-800 text-gray-400'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition">ç¾è‚¡</button>
                        </div>
                        <button @click="openModal('history')" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">+ è£œç™»ç´€éŒ„</button>
                    </div>
                    
                    <div v-if="filteredHistory.length === 0" class="text-center text-gray-500 py-10">å°šç„¡äº¤æ˜“ç´€éŒ„</div>

                    <div class="space-y-6">
                        <div v-for="(group, monthKey) in groupedHistory" :key="monthKey" class="bg-gray-900 border border-gray-800 rounded-xl shadow-xl overflow-x-auto">
                            <div class="bg-gray-800/80 px-6 py-3 flex justify-between items-center border-b border-gray-700">
                                <h3 class="text-white font-bold text-lg">{{ monthKey }}</h3>
                                <div><span class="text-gray-400 mr-2">å–®æœˆæç›Š:</span><span class="font-bold text-lg number-font" :class="getColorClass(group.monthTotal)">{{ historyFilter === 'us' ? '$ ' : '' }}{{ historyFilter === 'us' ? formatPrice(group.monthTotal) : formatCurrency(group.monthTotal) }}</span></div>
                            </div>
                            <table class="w-full text-sm">
                                <thead class="bg-gray-800/30 text-gray-500 text-xs uppercase">
                                    <tr>
                                        <th class="px-6 py-4 text-center">æ—¥æœŸ</th>
                                        <th class="px-6 py-4 text-center">åˆ†é¡</th>
                                        <th class="px-6 py-4 text-center">åç¨±</th>
                                        <th class="px-6 py-4 text-center">æˆäº¤åƒ¹</th>
                                        <th class="px-6 py-4 text-center">è‚¡æ•¸</th>
                                        <th class="px-6 py-4 text-center">ç²åˆ©</th>
                                        <th class="px-6 py-4 text-center">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">
                                    <tr v-for="r in group.items" :key="r.id" class="hover:bg-gray-800/50">
                                        <td class="px-6 py-4 text-center number-font text-gray-400">{{ r.date }}</td>
                                        <td class="px-6 py-4 text-center"><span class="px-2 py-0.5 rounded text-xs border" :class="getTypeBadge(r.type)">{{ r.type }}</span></td>
                                        <td class="px-6 py-4 text-center text-white font-bold">{{ r.name }} <span class="text-gray-500 font-normal">({{ r.code }})</span></td>
                                        <td class="px-6 py-4 text-center number-font">{{ historyFilter === 'us' ? formatPrice(r.price) : formatNumber(r.price) }}</td>
                                        <td class="px-6 py-4 text-center number-font">{{ formatNumber(r.volume) }}</td>
                                        <td class="px-6 py-4 text-center number-font font-bold" :class="getColorClass(r.netPL)">{{ historyFilter === 'us' ? '$ ' : '' }}{{ historyFilter === 'us' ? formatPrice(r.netPL) : formatCurrency(r.netPL) }}</td>
                                        <td class="px-6 py-4 text-center"><button @click="confirmDelete('history', r.id)" class="text-gray-500 hover:text-red-400">âœ•</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <transition name="modal">
                <div v-if="showModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                    <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-96 shadow-2xl">
                        <h3 class="text-lg font-bold mb-4 text-white">
                            <span v-if="modalMode==='sell'" class="text-red-400">è³£å‡ºè‚¡ç¥¨</span>
                            <span v-else>{{ modalMode === 'add' ? 'æ–°å¢' : 'ç·¨è¼¯' }} {{ modalTypeLabel }}</span>
                        </h3>
                        <div class="space-y-3">
                            <div><label class="text-xs text-gray-400">æ—¥æœŸ</label><input v-model="formData.date" type="date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                            
                            <div v-if="modalType.includes('holdings') || modalType.includes('stocks') || modalType==='history'">
                                <div class="grid grid-cols-2 gap-2" v-if="modalMode!=='sell' && modalMode!=='edit_lot'">
                                    <div><label class="text-xs text-gray-400">ä»£è™Ÿ</label><input v-model="formData.code" @blur="fetchStockName" type="text" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white uppercase" :disabled="modalMode==='edit'"></div>
                                    <div><label class="text-xs text-gray-400">åç¨±</label><input v-model="formData.name" type="text" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                                </div>
                                <div v-if="modalType!=='us_stocks' && modalMode!=='sell'"><label class="text-xs text-gray-400">åˆ†é¡</label><select v-model="formData.type" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"><option v-for="t in types" :value="t">{{ t }}</option></select></div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="text-xs text-gray-400">{{ modalMode==='sell'?'è³£å‡ºå‡åƒ¹':'åƒ¹æ ¼' }}</label><input v-model.number="formData.price" type="number" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                                    <div><label class="text-xs text-gray-400">è‚¡æ•¸</label><input v-model.number="formData.volume" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                                </div>
                                <div v-if="modalType==='holdings'"><label class="text-xs text-gray-400">æ‰‹çºŒè²»</label><input v-model.number="formData.fee" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                            </div>

                            <div v-if="modalType === 'gold'" class="grid grid-cols-2 gap-2">
                                <div><label class="text-xs text-gray-400">é‡é‡(g)</label><input v-model.number="formData.weight" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                                <div><label class="text-xs text-gray-400">æˆæœ¬</label><input v-model.number="formData.cost" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6"><button @click="handleModalSubmit" class="flex-1 py-2 rounded font-bold text-sm text-white" :class="modalMode==='sell'?'bg-red-600 hover:bg-red-500':'bg-blue-600 hover:bg-blue-500'">{{ modalMode==='sell'?'ç¢ºèªè³£å‡º':'å„²å­˜' }}</button><button @click="showModal=false" class="flex-1 bg-gray-700 text-white py-2 rounded font-bold text-sm">å–æ¶ˆ</button></div>
                    </div>
                </div>
            </transition>

            <transition name="modal">
                <div v-if="showDeleteModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                    <div class="bg-gray-900 border border-red-900/50 rounded-xl p-6 w-80 shadow-2xl text-center">
                        <h3 class="text-lg font-bold text-white mb-4">ç¢ºå®šåˆªé™¤?</h3>
                        <div class="flex gap-3"><button @click="executeDelete" class="flex-1 bg-red-600 text-white py-2 rounded">åˆªé™¤</button><button @click="showDeleteModal=false" class="flex-1 bg-gray-700 text-white py-2 rounded">å–æ¶ˆ</button></div>
                    </div>
                </div>
            </transition>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const currentTab = ref('dashboard');
                const historyFilter = ref('all');
                const currentTime = ref('');
                const loadingPrices = ref(false);
                const types = ['ç¾è‚¡', 'èè³‡', 'èåˆ¸', 'ç•¶æ²–', 'æœŸè²¨', 'å®šæœŸå®šé¡', 'å€Ÿåˆ¸'];
                
                const holdings = ref([]);
                const usHoldings = ref([]);
                const history = ref([]);
                const goldList = ref([]);
                const expandedSet = ref(new Set());

                const showModal = ref(false);
                const showDeleteModal = ref(false);
                const deleteTarget = ref(null);
                const modalMode = ref('add');
                const modalType = ref('holdings'); 
                const editingId = ref(null);
                const editingLotIndex = ref(null);
                const editingStock = ref(null);
                const formData = ref({});

                const initFirebaseSync = () => {
                    const { onSnapshot, collection, query, orderBy } = window.firebaseOps;
                    if(!window.db) return;
                    onSnapshot(collection(window.db, "holdings"), (s) => holdings.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                    onSnapshot(collection(window.db, "us_holdings"), (s) => usHoldings.value = s.docs.map(d => ({ id: d.id, ...d.data() }))); 
                    onSnapshot(query(collection(window.db, "history"), orderBy("date", "desc")), (s) => history.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                    onSnapshot(query(collection(window.db, "gold"), orderBy("date", "desc")), (s) => goldList.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                };

                const normalize = (str) => String(str || '').trim().toUpperCase().replace(/\.TW(O)?$/,'');
                const toggleExpand = (id) => { if (expandedSet.value.has(id)) expandedSet.value.delete(id); else expandedSet.value.add(id); };
                
                const switchTab = (tab, filter = null) => { currentTab.value = tab; if (filter) historyFilter.value = filter; };

                const sortedHoldings = computed(() => [...holdings.value].sort((a, b) => normalize(a.code).localeCompare(normalize(b.code))));
                const totalAssets = computed(() => holdings.value.reduce((a, b) => a + (b.currentPrice * b.volume), 0));
                const totalUnrealizedPL = computed(() => holdings.value.reduce((a, b) => a + ((b.currentPrice * b.volume) - (b.cost * b.volume)), 0));
                const totalUnrealizedPLRate = computed(() => { const c = holdings.value.reduce((a, b) => a + (b.cost * b.volume), 0); return c ? totalUnrealizedPL.value / c : 0; });
                const totalUSAssets = computed(() => usHoldings.value.reduce((a, b) => a + (b.currentPrice * b.volume), 0));
                const totalUSUnrealizedPL = computed(() => usHoldings.value.reduce((a, b) => a + ((b.currentPrice - b.cost) * b.volume), 0));
                const totalUSUnrealizedRate = computed(() => { const c = usHoldings.value.reduce((a, b) => a + (b.cost * b.volume), 0); return c ? totalUSUnrealizedPL.value / c : 0; });
                
                const twHistory = computed(() => history.value.filter(r => r.type !== 'ç¾è‚¡'));
                const usHistory = computed(() => history.value.filter(r => r.type === 'ç¾è‚¡'));
                const filteredHistory = computed(() => { if (historyFilter.value === 'tw') return twHistory.value; if (historyFilter.value === 'us') return usHistory.value; return history.value; });

                const totalRealizedPL = computed(() => history.value.reduce((a, b) => a + (b.netPL||0), 0));
                const totalTwRealizedPL = computed(() => twHistory.value.reduce((a, b) => a + (b.netPL||0), 0));
                const totalUsRealizedPL = computed(() => usHistory.value.reduce((a, b) => a + (b.netPL||0), 0));
                const groupedHistory = computed(() => {
                    const groups = {};
                    filteredHistory.value.forEach(item => { const m = item.date.substring(0, 7); if (!groups[m]) groups[m] = { monthTotal: 0, items: [] }; groups[m].items.push(item); groups[m].monthTotal += (item.netPL || 0); });
                    return Object.keys(groups).sort().reverse().reduce((obj, key) => { obj[key] = groups[key]; return obj; }, {});
                });

                const annualROI = computed(() => totalRealizedPL.value / 5000000);
                const totalGoldWeight = computed(() => goldList.value.reduce((a, b) => a + (b.weight || 0), 0));
                const totalGoldCost = computed(() => goldList.value.reduce((a, b) => a + (b.cost || 0), 0));
                const grandTotalAssets = computed(() => totalAssets.value + (totalUSAssets.value * 32) + totalGoldCost.value);
                const modalTypeLabel = computed(() => modalType.value==='gold'?'é»ƒé‡‘':(modalType.value==='us_stocks'?'ç¾è‚¡':(modalType.value==='history'?'ç´€éŒ„':'å°è‚¡')));

                const handleModalSubmit = async () => {
                    const { addDoc, updateDoc, collection, doc } = window.firebaseOps;
                    const colName = modalType.value === 'us_stocks' ? 'us_holdings' : modalType.value;
                    let data = { ...formData.value };

                    // â˜… é˜²å‘†ï¼šè² æ•¸æª¢æŸ¥ (åš´æ ¼é˜»æ“‹) â˜…
                    if (data.volume < 0 || data.price < 0 || data.cost < 0 || data.weight < 0) { 
                        alert('æ•¸å€¼ä¸èƒ½ç‚ºè² æ•¸ï¼'); 
                        return; 
                    }

                    if (modalMode.value === 'sell') {
                        const isTw = modalType.value === 'holdings';
                        const tax = isTw ? Math.floor(data.price * data.volume * 0.003) : 0;
                        const fee = isTw ? Math.floor(data.price * data.volume * 0.001425) : 0;
                        const netPL = Math.floor((data.price - editingStock.value.cost) * data.volume - tax - fee);
                        await addDoc(collection(window.db, 'history'), { date: data.date, code: editingStock.value.code, name: editingStock.value.name, type: isTw ? 'å°è‚¡' : 'ç¾è‚¡', price: data.price, volume: data.volume, fee, tax, netPL, roi: 0 });
                        let remain = data.volume;
                        let newLots = [...(editingStock.value.lots||[])];
                        while(remain > 0 && newLots.length > 0) { if(newLots[0].volume <= remain) { remain -= newLots[0].volume; newLots.shift(); } else { newLots[0].volume -= remain; remain=0; } }
                        const newVol = editingStock.value.volume - data.volume;
                        if(newVol <= 0) await window.firebaseOps.deleteDoc(doc(window.db, colName, editingStock.value.id)); else await updateDoc(doc(window.db, colName, editingStock.value.id), { volume: newVol, lots: newLots });
                        showModal.value = false; return;
                    }

                    if (modalMode.value === 'edit_lot') {
                        let newLots = [...editingStock.value.lots];
                        newLots[editingLotIndex.value] = { date: data.date, price: Number(data.price), volume: Number(data.volume), fee: Number(data.fee||0) };
                        let nv=0, nc=0; newLots.forEach(l => { nv+=l.volume; nc+=(l.price*l.volume); });
                        await updateDoc(doc(window.db, colName, editingStock.value.id), { lots: newLots, volume: nv, cost: nv>0?nc/nv:0 });
                        showModal.value = false; return;
                    }

                    data.price = Number(data.price)||0; data.volume = Number(data.volume)||0;
                    if(colName!=='gold' && colName!=='history') { data.code = normalize(data.code); if(!data.name) data.name=data.code; }

                    if(colName === 'gold' || colName === 'history') {
                        if(modalMode.value==='add') await addDoc(collection(window.db, colName), data); else await updateDoc(doc(window.db, colName, editingId.value), data);
                    } else {
                        const newLot = { date: data.date, price: data.price, volume: data.volume, fee: data.fee||0 };
                        if(modalMode.value === 'add') {
                            const list = colName==='holdings'?holdings.value:usHoldings.value;
                            const ex = list.find(h => normalize(h.code)===data.code && (colName==='us_holdings' || normalize(h.type)===normalize(data.type)));
                            if(ex) {
                                const ov=Number(ex.volume), nv=Number(data.volume);
                                await updateDoc(doc(window.db, colName, ex.id), { volume: ov+nv, cost: ((ex.cost*ov)+(data.price*nv))/(ov+nv), lots: [...(ex.lots||[]), newLot] });
                            } else { await addDoc(collection(window.db, colName), { ...data, cost: data.price, currentPrice: data.price, lots: [newLot] }); }
                        } else await updateDoc(doc(window.db, colName, editingId.value), data);
                    }
                    showModal.value = false;
                };

                const openModal = (type) => { modalType.value = type; modalMode.value = 'add'; formData.value = { date: new Date().toISOString().split('T')[0], type: 'ç¾è‚¡', price: 0, volume: 1000, weight: 1, cost: 0 }; showModal.value = true; };
                const openSellModal = (stock) => { modalType.value = currentTab.value; modalMode.value = 'sell'; editingStock.value = stock; formData.value = { date: new Date().toISOString().split('T')[0], price: stock.currentPrice, volume: stock.volume, code: stock.code, name: stock.name }; showModal.value = true; };
                const openEditLotModal = (stock, idx) => { modalType.value = currentTab.value; modalMode.value = 'edit_lot'; editingStock.value = stock; editingLotIndex.value = idx; const lot = stock.lots[idx]; formData.value = { ...lot }; showModal.value = true; };
                const editItem = (type, item) => { modalType.value = type; modalMode.value = 'edit'; editingId.value = item.id; formData.value = { ...item }; if(type.includes('holdings')) formData.value.price = item.cost; showModal.value = true; };
                const confirmDelete = (type, id) => { deleteTarget.value = { col: type==='us_stocks'?'us_holdings':type, id }; showDeleteModal.value = true; };
                const executeDelete = async () => { await window.firebaseOps.deleteDoc(window.firebaseOps.doc(window.db, deleteTarget.value.col, deleteTarget.value.id)); showDeleteModal.value = false; };
                const deleteLot = async (stock, idx) => { if(!confirm('åˆªé™¤?')) return; const col = currentTab.value==='us_stocks'?'us_holdings':'holdings'; let lots=[...stock.lots]; lots.splice(idx,1); let nv=0, nc=0; lots.forEach(l=>{nv+=l.volume;nc+=(l.price*l.volume)}); if(nv<=0) await window.firebaseOps.deleteDoc(window.firebaseOps.doc(window.db, col, stock.id)); else await window.firebaseOps.updateDoc(window.firebaseOps.doc(window.db, col, stock.id), {lots, volume:nv, cost:nc/nv}); };
                const refreshPrices = async (t) => { loadingPrices.value=true; const l=t==='us'?usHoldings.value:holdings.value; const s=[...new Set(l.map(h=>h.code))]; if(s.length>0) { try{const r=await fetch(`/api/quote?symbols=${s.join(',')}`); const d=await r.json(); const {updateDoc,doc}=window.firebaseOps; for(const x of l){const k=normalize(x.code); const v=d[k]||d[`${k}.TW`]; if(v&&v.price) await updateDoc(doc(window.db,t==='us'?'us_holdings':'holdings',x.id),{currentPrice:v.price});}}catch(e){}} loadingPrices.value=false; };
                const fetchStockName = async () => { const c=formData.value.code; if(!c) return; try{const r=await fetch(`/api/quote?symbols=${c}`);const d=await r.json(); const k=normalize(c); const v=d[k]||d[`${k}.TW`]; if(v&&v.name){ formData.value.name=v.name; if(modalMode.value==='add') formData.value.price=v.price; }}catch(e){} };
                
                const getTabClass = (t) => currentTab.value === t ? 'bg-gray-800 text-white shadow-lg border-r-4 border-blue-500' : 'text-gray-400 hover:bg-gray-800/50 hover:text-white';
                const formatCurrency = (v) => new Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD', minimumFractionDigits:0}).format(v||0);
                const formatNumber = (v) => new Intl.NumberFormat('zh-TW').format(v||0);
                const formatPrice = (v) => new Intl.NumberFormat('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v||0);
                const formatPercent = (v) => ((v||0) * 100).toFixed(2) + '%';
                const getColorClass = (v) => v > 0 ? 'text-up' : (v < 0 ? 'text-down' : 'text-gray-400');
                const getPriceColor = (s) => s.currentPrice > s.cost ? 'text-up' : (s.currentPrice < s.cost ? 'text-down' : 'text-white');
                const getTypeBadge = (t) => { const m = {'ç¾è‚¡':'border-blue-800 text-blue-400', 'èè³‡':'border-orange-800 text-orange-400', 'æœŸè²¨':'border-red-800 text-red-400', 'ç¾è‚¡':'border-indigo-800 text-indigo-400'}; return m[t] ? `bg-${m[t].split(' ')[0].replace('border-','')} ${m[t]}` : 'bg-gray-800 text-gray-300'; };
                const calculateUnrealizedPL = (s) => (s.currentPrice * s.volume) - (s.cost * s.volume);
                const calculateUnrealizedRate = (s) => s.cost ? (s.currentPrice - s.cost) / s.cost : 0;

                onMounted(() => {
                    window.addEventListener('firebase-ready', () => { initFirebaseSync(); });
                    if (window.db) initFirebaseSync();
                    setInterval(() => currentTime.value = new Date().toLocaleString('zh-TW', {hour12:false}), 1000);
                });

                return { 
                    currentTab, historyFilter, currentTime, holdings, usHoldings, sortedHoldings, history, goldList, 
                    showModal, showDeleteModal, modalMode, modalType, formData, types, modalTypeLabel,
                    totalAssets, totalUnrealizedPL, totalUnrealizedPLRate, totalRealizedPL, totalTwRealizedPL, totalUsRealizedPL,
                    annualROI, grandTotalAssets, totalUSAssets, totalUSUnrealizedPL, totalUSUnrealizedRate, totalGoldWeight, totalGoldCost,
                    loadingPrices, expandedSet, groupedHistory, filteredHistory,
                    openModal, editItem, confirmDelete, executeDelete, handleModalSubmit, openSellModal, openEditLotModal, deleteLot,
                    switchTab, refreshPrices, fetchStockName, toggleExpand, getTabClass,
                    formatCurrency, formatNumber, formatPrice, formatPercent, getColorClass, getPriceColor, getTypeBadge, calculateUnrealizedPL, calculateUnrealizedRate 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>