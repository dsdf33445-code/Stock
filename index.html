<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA TRADER Pro - Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ‚òÖ‚òÖ‚òÖ Ë´ãÂú®Ê≠§Â°´ÂÖ•ÊÇ®ÁöÑ Firebase Ë®≠ÂÆö ‚òÖ‚òÖ‚òÖ
        const firebaseConfig = {
  	apiKey: "AIzaSyCV5sUAZz5Lo226gv2ryuJeCLlnRC5KQrY",
  	authDomain: "stock-12290.firebaseapp.com",
  	projectId: "stock-12290",
  	storageBucket: "stock-12290.firebasestorage.app",
  	messagingSenderId: "586421910135",
  	appId: "1:586421910135:web:df8c590c25e733e1392472",
  	measurementId: "G-XR417P8PEN"
	};

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app); // Áõ¥Êé•ÂàùÂßãÂåñ db
        window.firebaseOps = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter'], mono: ['JetBrains Mono'] },
                    colors: { gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' }, up: '#ef4444', down: '#22c55e' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .number-font { font-family: 'JetBrains Mono', monospace; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 h-screen overflow-hidden flex flex-col font-sans">

    <div id="app" v-cloak class="flex h-full">
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <h1 class="text-xl font-bold tracking-wider text-blue-400">ALPHA TRADER</h1>
                <p class="text-xs text-gray-500 mt-1">Cloud Sync Enabled</p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button v-for="tab in ['dashboard', 'holdings', 'history']" :key="tab"
                    @click="currentTab = tab" 
                    :class="currentTab === tab ? 'bg-blue-600/20 text-blue-400' : 'text-gray-400 hover:bg-gray-800'"
                    class="w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors capitalize flex items-center">
                    {{ tab === 'dashboard' ? 'Á∏ΩË¶ΩÂÑÄË°®Êùø' : tab === 'holdings' ? 'Â∫´Â≠òÊåÅËÇ°' : 'Â∑≤ÂØ¶ÁèæÊêçÁõä' }}
                </button>
            </nav>
            <div class="p-4 border-t border-gray-800 text-xs text-gray-500 text-center">
                {{ currentTime }}
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            <header class="bg-gray-900/50 border-b border-gray-800 p-6 backdrop-blur-sm grid grid-cols-4 gap-6">
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-xs mb-1">Á∏ΩË≥áÁî¢</div>
                    <div class="text-2xl font-bold number-font">{{ formatCurrency(totalAssets) }}</div>
                </div>
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-xs mb-1">Êú™ÂØ¶ÁèæÊêçÁõä</div>
                    <div :class="getColorClass(totalUnrealizedPL)" class="text-2xl font-bold number-font">
                        {{ formatCurrency(totalUnrealizedPL) }}
                        <span class="text-sm ml-2">({{ formatPercent(totalUnrealizedPLRate) }})</span>
                    </div>
                </div>
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-xs mb-1">Â∑≤ÂØ¶ÁèæÊêçÁõä</div>
                    <div :class="getColorClass(totalRealizedPL)" class="text-2xl font-bold number-font">{{ formatCurrency(totalRealizedPL) }}</div>
                </div>
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-xs mb-1">Âπ¥Â∫¶Â†±ÈÖ¨Áéá</div>
                    <div :class="getColorClass(annualROI)" class="text-2xl font-bold number-font">{{ formatPercent(annualROI) }}</div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-6 relative">
                <div v-if="currentTab === 'dashboard' || currentTab === 'holdings'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-3">
                            <span class="w-1 h-6 bg-blue-500 rounded-full"></span> Â∫´Â≠òÊåÅËÇ°
                            <button @click="refreshPrices" class="text-xs bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded border border-gray-700 transition flex items-center gap-1">
                                <span v-if="loadingPrices" class="animate-spin">‚ü≥</span>
                                <span>{{ loadingPrices ? 'Êõ¥Êñ∞‰∏≠...' : 'üîÑ Êõ¥Êñ∞ËÇ°ÂÉπ' }}</span>
                            </button>
                        </h2>
                        <button @click="openModal('holdings')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            + Êñ∞Â¢ûÊåÅËÇ°
                        </button>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">Êìç‰Ωú</th>
                                    <th class="px-4 py-3">‰ª£Ëôü/ÂêçÁ®±</th>
                                    <th class="px-4 py-3 text-right">ÊàêÊú¨</th>
                                    <th class="px-4 py-3 text-right">ÁèæÂÉπ</th>
                                    <th class="px-4 py-3 text-right">ËÇ°Êï∏</th>
                                    <th class="px-4 py-3 text-right">ÊêçÁõä</th>
                                    <th class="px-4 py-3 text-right">%</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="stock in holdings" :key="stock.id" class="hover:bg-gray-800/50">
                                    <td class="px-4 py-3 flex gap-2">
                                        <button @click="editItem('holdings', stock)" class="text-gray-500 hover:text-blue-400">‚úé</button>
                                        <button @click="deleteItem('holdings', stock.id)" class="text-gray-500 hover:text-red-400">‚úï</button>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-bold text-white flex items-center gap-2">
                                            {{ stock.code }} 
                                            <span :class="getTypeBadge(stock.type)" class="text-[10px] px-1 rounded border font-normal">{{ stock.type }}</span>
                                        </div>
                                        <div class="text-gray-500 text-xs">{{ stock.name }}</div>
                                    </td>
                                    <td class="px-4 py-3 text-right number-font">{{ formatNumber(stock.cost) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getPriceColor(stock)">{{ formatNumber(stock.currentPrice) }}</td>
                                    <td class="px-4 py-3 text-right number-font">{{ formatNumber(stock.volume) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">
                                        {{ formatCurrency(calculateUnrealizedPL(stock)) }}
                                    </td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">
                                        {{ formatPercent(calculateUnrealizedRate(stock)) }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'dashboard' || currentTab === 'history'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-3">
                            <span class="w-1 h-6 bg-purple-500 rounded-full"></span> Â∑≤ÂØ¶ÁèæÊêçÁõä
                        </h2>
                        <button @click="openModal('history')" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            + Êñ∞Â¢ûÁ¥ÄÈåÑ
                        </button>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">Êìç‰Ωú</th>
                                    <th class="px-4 py-3">Êó•Êúü</th>
                                    <th class="px-4 py-3">‰ª£Ëôü/ÂêçÁ®±</th>
                                    <th class="px-4 py-3 text-right">Áç≤Âà©</th>
                                    <th class="px-4 py-3 text-right">%</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="record in history" :key="record.id" class="hover:bg-gray-800/50">
                                    <td class="px-4 py-3 flex gap-2">
                                        <button @click="editItem('history', record)" class="text-gray-500 hover:text-blue-400">‚úé</button>
                                        <button @click="deleteItem('history', record.id)" class="text-gray-500 hover:text-red-400">‚úï</button>
                                    </td>
                                    <td class="px-4 py-3 text-gray-400 number-font text-xs">{{ record.date }}</td>
                                    <td class="px-4 py-3">
                                        <span class="font-bold text-white">{{ record.code }}</span>
                                        <span class="text-gray-500 text-xs ml-1">{{ record.name }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(record.netPL)">{{ formatCurrency(record.netPL) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(record.netPL)">{{ formatPercent(record.roi) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <transition name="modal">
                <div v-if="showModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                    <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-96 shadow-2xl">
                        <h3 class="text-lg font-bold mb-4 text-white">{{ modalMode === 'add' ? 'Êñ∞Â¢û' : 'Á∑®ËºØ' }} {{ modalType === 'holdings' ? 'Â∫´Â≠ò' : 'Á¥ÄÈåÑ' }}</h3>
                        
                        <div class="space-y-3">
                            <div v-if="modalType === 'history'">
                                <label class="text-xs text-gray-400">Êó•Êúü</label>
                                <input v-model="formData.date" type="date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                            </div>
                            
                            <div>
                                <label class="text-xs text-gray-400">ËÇ°Á•®‰ª£Ëôü</label>
                                <div class="flex gap-2">
                                    <input v-model="formData.code" @blur="fetchStockName" type="text" placeholder="ex: 2330" class="flex-1 bg-gray-800 border border-gray-700 rounded p-2 text-white uppercase focus:border-blue-500 outline-none">
                                    <button @click="fetchStockName" class="bg-gray-700 hover:bg-gray-600 px-3 rounded text-white text-xs">
                                        <span v-if="fetchingName">...</span>
                                        <span v-else>üîç</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs text-gray-400">ËÇ°Á•®ÂêçÁ®±</label>
                                <input v-model="formData.name" type="text" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none">
                            </div>

                            <div>
                                <label class="text-xs text-gray-400">ÂàÜÈ°û</label>
                                <select v-model="formData.type" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                                    <option v-for="t in types" :value="t">{{ t }}</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-gray-400">{{ modalType === 'holdings' ? 'ÊàêÊú¨ÂùáÂÉπ' : 'Êàê‰∫§ÂÉπ' }}</label>
                                    <input v-model.number="formData.price" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">ËÇ°Êï∏</label>
                                    <input v-model.number="formData.volume" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                                </div>
                            </div>

                            <div v-if="modalType === 'history'" class="pt-2 border-t border-gray-800 space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="text-xs text-gray-400">Ê∑®ÊêçÁõä</label><input v-model.number="formData.netPL" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                                    <div><label class="text-xs text-gray-400">Â†±ÈÖ¨Áéá</label><input v-model.number="formData.roi" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div>ÊâãÁ∫åË≤ª <input v-model.number="formData.fee" class="bg-gray-800 w-full border border-gray-700 rounded p-1"></div>
                                    <div>Á®Ö <input v-model.number="formData.tax" class="bg-gray-800 w-full border border-gray-700 rounded p-1"></div>
                                </div>
                                <button @click="autoCalculate" class="w-full text-xs text-blue-400 border border-blue-900 rounded py-1 hover:bg-blue-900/30">‚ö° Ë©¶ÁÆó (Ë≥£Âá∫Ê®°Âºè)</button>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button @click="saveData" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold text-sm">ÂÑ≤Â≠ò</button>
                            <button @click="showModal = false" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-bold text-sm">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>
            </transition>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const currentTab = ref('dashboard');
                const currentTime = ref('');
                const loadingPrices = ref(false);
                const fetchingName = ref(false); // ÊäìÂèñ‰ª£ËôüÁãÄÊÖã
                const types = ['ÁèæËÇ°', 'ËûçË≥á', 'ËûçÂà∏', 'Áï∂Ê≤ñ', 'ÊúüË≤®', 'ÂÆöÊúüÂÆöÈ°ç', 'ÂÄüÂà∏'];

                const holdings = ref([]);
                const history = ref([]);
                
                const showModal = ref(false);
                const modalMode = ref('add');
                const modalType = ref('holdings');
                const editingId = ref(null);
                const formData = ref({});

                // ----------------- Firebase Sync -----------------
                const initFirebaseSync = () => {
                    const { onSnapshot, collection, query, orderBy } = window.firebaseOps;
                    if(!window.db) return;

                    // Áõ£ËÅΩÊåÅËÇ°
                    onSnapshot(collection(window.db, "holdings"), (snapshot) => {
                        holdings.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    // Áõ£ËÅΩÊ≠∑Âè≤
                    const historyq = query(collection(window.db, "history"), orderBy("date", "desc"));
                    onSnapshot(historyq, (snapshot) => {
                        history.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                };

                // ----------------- ÂäüËÉΩÈÇèËºØ -----------------
                
                // 1. Ëá™ÂãïÊäìËÇ°Á•®ÂêçÁ®±
                const fetchStockName = async () => {
                    const code = formData.value.code;
                    if (!code || code.length < 3) return;
                    
                    fetchingName.value = true;
                    try {
                        // ÂëºÂè´ÊàëÂÄëÁöÑÊñ∞ÂæåÁ´Ø API
                        const res = await fetch(`/api/quote?symbols=${code}`);
                        const data = await res.json();
                        
                        // data[code] ÂèØËÉΩË¶ÅËôïÁêÜÂ§ßÂ∞èÂØ´
                        const stockData = data[code.toUpperCase()] || data[Object.keys(data)[0]];
                        
                        if (stockData && stockData.name) {
                            formData.value.name = stockData.name;
                            // Â¶ÇÊûúÊòØÊñ∞Â¢ûÊ®°Âºè‰∏îÂ∞öÊú™Â°´ÂÉπÊ†ºÔºåÈ†Ü‰æøÂ°´ÂÖ•ÁèæÂÉπ
                            if (modalMode.value === 'add' && !formData.value.price) {
                                formData.value.price = stockData.price; 
                            }
                        }
                    } catch (e) {
                        console.error("Êü•ÁÑ°Ê≠§ËÇ°", e);
                    }
                    fetchingName.value = false;
                };

                // 2. ÂÑ≤Â≠òË≥áÊñô (‰øÆÊ≠£‰∏çÈ°ØÁ§∫ÁöÑ Bug)
                const saveData = async () => {
                    const { addDoc, updateDoc, collection, doc } = window.firebaseOps;
                    const colName = modalType.value;
                    let data = { ...formData.value };

                    // ËΩâÊï∏ÂÄºÈò≤Ê≠¢Â≠ó‰∏≤Ë®àÁÆóÈåØË™§
                    data.price = Number(data.price) || 0;
                    data.volume = Number(data.volume) || 0;
                    if (!data.name) data.name = data.code; // Èò≤ÂëÜ

                    if (colName === 'holdings') {
                        data.cost = data.price; 
                        // ‚òÖ‚òÖ‚òÖ ÈóúÈçµ‰øÆÊ≠£ÔºöÁ¢∫‰øù currentPrice ÊúâÂÄºÔºåÂê¶ÂâáÂâçÁ´ØË®àÁÆóÊêçÁõäÊúÉÊòØ NaN Â∞éËá¥‰∏çÈ°ØÁ§∫ ‚òÖ‚òÖ‚òÖ
                        if (data.currentPrice === undefined || data.currentPrice === 0) {
                            data.currentPrice = data.cost;
                        }
                        delete data.price;
                    } else {
                        data.fee = Number(data.fee) || 0;
                        data.tax = Number(data.tax) || 0;
                        data.netPL = Number(data.netPL) || 0;
                        data.roi = Number(data.roi) || 0;
                    }

                    try {
                        if (modalMode.value === 'add') {
                            await addDoc(collection(window.db, colName), data);
                        } else {
                            await updateDoc(doc(window.db, colName, editingId.value), data);
                        }
                        showModal.value = false;
                    } catch (e) {
                        alert("ÂÑ≤Â≠òÂ§±Êïó: " + e.message);
                    }
                };

                // 3. ÊâπÈáèÊõ¥Êñ∞ËÇ°ÂÉπ
                const refreshPrices = async () => {
                    loadingPrices.value = true;
                    const symbols = [...new Set(holdings.value.map(h => h.code))];
                    if(symbols.length === 0) { loadingPrices.value = false; return; }

                    try {
                        const res = await fetch(`/api/quote?symbols=${symbols.join(',')}`);
                        const data = await res.json();
                        const { updateDoc, doc } = window.firebaseOps;
                        
                        for (const stock of holdings.value) {
                            const key = stock.code.toUpperCase();
                            const stockData = data[key] || data[`${key}.TW`]; // ÂòóË©¶ÂåπÈÖç
                            
                            if (stockData && stockData.price) {
                                await updateDoc(doc(window.db, "holdings", stock.id), {
                                    currentPrice: stockData.price,
                                    name: stockData.name || stock.name // È†Ü‰æøÊõ¥Êñ∞ÂêçÁ®±
                                });
                            }
                        }
                    } catch (e) {
                        console.error("ËÇ°ÂÉπÊõ¥Êñ∞Â§±Êïó", e);
                    }
                    loadingPrices.value = false;
                };

                // Modal Êìç‰Ωú
                const openModal = (type) => {
                    modalType.value = type;
                    modalMode.value = 'add';
                    formData.value = { date: new Date().toISOString().split('T')[0], type: 'ÁèæËÇ°', price: 0, volume: 1000 };
                    showModal.value = true;
                };

                const editItem = (type, item) => {
                    modalType.value = type;
                    modalMode.value = 'edit';
                    editingId.value = item.id;
                    formData.value = { ...item };
                    if(type === 'holdings') formData.value.price = item.cost;
                    showModal.value = true;
                };

                const deleteItem = async (type, id) => {
                    if(confirm('Á¢∫ÂÆöÂà™Èô§?')) await window.firebaseOps.deleteDoc(window.firebaseOps.doc(window.db, type, id));
                };

                const autoCalculate = () => {
                    const p = formData.value.price;
                    const v = formData.value.volume;
                    const fee = Math.floor(p * v * 0.001425); 
                    const tax = Math.floor(p * v * 0.003);
                    formData.value.fee = fee;
                    formData.value.tax = tax;
                    // ÂÅáË®≠Á∞°ÊòìÁç≤Âà© (Ë≥£ÂÉπ-ÊàêÊú¨)ÔºåÈÄôË£°Âè™ÊòØËºîÂä©Ë®àÁÆó
                    alert('Â∑≤Â°´ÂÖ•È†ê‰º∞ÊâãÁ∫åË≤ªËàáÁ®ÖÔºåË´ãÊâãÂãïËº∏ÂÖ•ÂØ¶ÈöõÊ∑®ÊêçÁõä');
                };

                // Ë®àÁÆóÈ°ØÁ§∫
                const formatCurrency = (v) => new Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD', minimumFractionDigits:0}).format(v||0);
                const formatNumber = (v) => new Intl.NumberFormat('zh-TW').format(v||0);
                const formatPercent = (v) => ((v||0) * 100).toFixed(2) + '%';
                const getColorClass = (v) => v > 0 ? 'text-up' : (v < 0 ? 'text-down' : 'text-gray-400');
                const getPriceColor = (s) => s.currentPrice > s.cost ? 'text-up' : (s.currentPrice < s.cost ? 'text-down' : 'text-white');
                const getTypeBadge = (t) => {
                    const m = {'ÁèæËÇ°':'border-blue-800 text-blue-400', 'ËûçË≥á':'border-orange-800 text-orange-400', 'ÊúüË≤®':'border-red-800 text-red-400'};
                    return m[t] ? `bg-${m[t].split(' ')[0].replace('border-','')} ${m[t]}` : 'bg-gray-800 text-gray-300';
                };
                
                const calculateUnrealizedPL = (s) => (s.currentPrice * s.volume) - (s.cost * s.volume);
                const calculateUnrealizedRate = (s) => s.cost ? (s.currentPrice - s.cost) / s.cost : 0;
                
                const totalAssets = computed(() => holdings.value.reduce((a, b) => a + (b.currentPrice * b.volume), 0));
                const totalUnrealizedPL = computed(() => holdings.value.reduce((a, b) => a + calculateUnrealizedPL(b), 0));
                const totalUnrealizedPLRate = computed(() => {
                    const cost = holdings.value.reduce((a, b) => a + (b.cost * b.volume), 0);
                    return cost ? totalUnrealizedPL.value / cost : 0;
                });
                const totalRealizedPL = computed(() => history.value.reduce((a, b) => a + (b.netPL||0), 0));
                const annualROI = computed(() => totalRealizedPL.value / 5000000);

                onMounted(() => {
                    const check = setInterval(() => {
                        if (window.firebaseOps && window.db) {
                            initFirebaseSync();
                            clearInterval(check);
                        }
                    }, 200);
                    setInterval(() => currentTime.value = new Date().toLocaleString('zh-TW', {hour12:false}), 1000);
                });

                return { 
                    currentTab, currentTime, holdings, history, showModal, modalMode, modalType, formData, types, 
                    totalAssets, totalUnrealizedPL, totalUnrealizedPLRate, totalRealizedPL, annualROI, loadingPrices, fetchingName,
                    openModal, editItem, deleteItem, saveData, autoCalculate, refreshPrices, fetchStockName,
                    formatCurrency, formatNumber, formatPercent, getColorClass, getPriceColor, getTypeBadge, calculateUnrealizedPL, calculateUnrealizedRate 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>