<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA TRADER Pro - Global Asset Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        async function initApp() {
            try {
                const res = await fetch('/api/config');
                if (!res.ok) throw new Error('API_FAIL');
                const firebaseConfig = await res.json();

                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.firebaseOps = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp };
                window.dispatchEvent(new Event('firebase-ready'));
                console.log("Firebase initialized");
            } catch (e) {
                console.error(e);
                alert("âš ï¸ ç³»çµ±è­¦å‘Šï¼šç„¡æ³•è®€å–è¨­å®šï¼Œè«‹æª¢æŸ¥ API é€£ç·šã€‚");
            }
        }
        initApp();
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter'], mono: ['JetBrains Mono'] },
                    colors: { gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' }, up: '#ef4444', down: '#22c55e', gold: '#fbbf24', us: '#3b82f6' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .number-font { font-family: 'JetBrains Mono', monospace; }
        [v-cloak] { display: none; }
        .expand-enter-active, .expand-leave-active { transition: all 0.3s ease; max-height: 500px; opacity: 1; overflow: hidden; }
        .expand-enter-from, .expand-leave-to { max-height: 0; opacity: 0; }
        
        /* å´é‚Šæ¬„æŒ‰éˆ•æ¨£å¼ */
        .nav-btn { 
            @apply w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center mb-1 whitespace-nowrap overflow-hidden; 
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 h-screen overflow-hidden flex flex-col font-sans">

    <div id="app" v-cloak class="flex h-full">
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col flex-shrink-0">
            <div class="p-6 border-b border-gray-800">
                <h1 class="text-xl font-bold tracking-wider text-blue-400">ALPHA TRADER</h1>
                <p class="text-xs text-gray-500 mt-1">Global Asset Wallet</p>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button @click="currentTab = 'dashboard'" :class="getTabClass('dashboard')" class="nav-btn">
                    <span class="w-6 mr-2">ğŸ“Š</span> ç¸½è¦½å„€è¡¨æ¿
                </button>
                <button @click="currentTab = 'holdings'" :class="getTabClass('holdings')" class="nav-btn">
                    <span class="w-6 mr-2">ğŸ’¼</span> å°è‚¡åº«å­˜
                </button>
                <button @click="currentTab = 'us_stocks'" :class="getTabClass('us_stocks')" class="nav-btn hover:bg-blue-900/20">
                    <span class="w-6 mr-2">ğŸ‡ºğŸ‡¸</span> ç¾è‚¡é…ç½®
                </button>
                <button @click="currentTab = 'gold'" :class="getTabClass('gold')" class="nav-btn text-yellow-500 hover:bg-yellow-900/20">
                    <span class="w-6 mr-2">ğŸ†</span> é»ƒé‡‘å­˜æ‘º
                </button>
                <button @click="currentTab = 'history'" :class="getTabClass('history')" class="nav-btn">
                    <span class="w-6 mr-2">ğŸ“œ</span> å·²å¯¦ç¾æç›Š
                </button>
            </nav>
            <div class="p-4 border-t border-gray-800 text-xs text-gray-500 text-center">
                {{ currentTime }}
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            
            <header class="bg-gray-900/50 border-b border-gray-800 p-6 backdrop-blur-sm">
                <div v-if="currentTab === 'gold'" class="grid grid-cols-2 gap-6">
                     <div class="bg-yellow-900/20 rounded-xl p-4 border border-yellow-700/50">
                        <div class="text-yellow-500 text-xs mb-1">åº«å­˜ç¸½å…‹æ•¸ (g)</div>
                        <div class="text-3xl font-bold number-font text-yellow-400">{{ formatNumber(totalGoldWeight) }} g</div>
                    </div>
                    <div class="bg-yellow-900/20 rounded-xl p-4 border border-yellow-700/50">
                        <div class="text-yellow-500 text-xs mb-1">é»ƒé‡‘ç¸½æˆæœ¬</div>
                        <div class="text-3xl font-bold number-font text-white">{{ formatCurrency(totalGoldCost) }}</div>
                    </div>
                </div>

                <div v-else-if="currentTab === 'us_stocks'" class="grid grid-cols-2 gap-6">
                    <div class="bg-blue-900/20 rounded-xl p-4 border border-blue-700/50">
                        <div class="text-blue-400 text-xs mb-1">ç¾è‚¡ç¸½è³‡ç”¢ (USD)</div>
                        <div class="text-3xl font-bold number-font text-white">$ {{ formatPrice(totalUSAssets) }}</div>
                    </div>
                    <div class="bg-blue-900/20 rounded-xl p-4 border border-blue-700/50">
                        <div class="text-blue-400 text-xs mb-1">æœªå¯¦ç¾æç›Š (USD)</div>
                        <div :class="getColorClass(totalUSUnrealizedPL)" class="text-3xl font-bold number-font">
                            $ {{ formatPrice(totalUSUnrealizedPL) }}
                            <span class="text-lg ml-2">({{ formatPercent(totalUSUnrealizedRate) }})</span>
                        </div>
                    </div>
                </div>

                <div v-else class="grid grid-cols-4 gap-6">
                    <div class="stat-card">
                        <div class="text-gray-400 text-xs mb-1">å°è‚¡ç¸½è³‡ç”¢</div>
                        <div class="text-2xl font-bold number-font">{{ formatCurrency(totalAssets) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-gray-400 text-xs mb-1">æœªå¯¦ç¾æç›Š</div>
                        <div :class="getColorClass(totalUnrealizedPL)" class="text-2xl font-bold number-font">
                            {{ formatCurrency(totalUnrealizedPL) }}
                            <span class="text-sm ml-2">({{ formatPercent(totalUnrealizedPLRate) }})</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-gray-400 text-xs mb-1">å·²å¯¦ç¾æç›Š</div>
                        <div :class="getColorClass(totalRealizedPL)" class="text-2xl font-bold number-font">{{ formatCurrency(totalRealizedPL) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-gray-400 text-xs mb-1">å¹´åº¦å ±é…¬ç‡</div>
                        <div :class="getColorClass(annualROI)" class="text-2xl font-bold number-font">{{ formatPercent(annualROI) }}</div>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-6 relative scroll-smooth">
                
                <div v-if="currentTab === 'dashboard' || currentTab === 'holdings'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-3">
                            <span class="w-1 h-6 bg-blue-500 rounded-full"></span> å°è‚¡åº«å­˜
                            <button @click="refreshPrices('tw')" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded border border-gray-700 transition flex items-center gap-2">
                                <span v-if="loadingPrices" class="animate-spin">âŸ³</span>
                                <span>{{ loadingPrices ? 'æ›´æ–°ä¸­...' : 'ğŸ”„ æ›´æ–°å°è‚¡' }}</span>
                            </button>
                        </h2>
                        <button @click="openModal('holdings')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            + æ–°å¢å°è‚¡
                        </button>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">åˆ†é¡</th>
                                    <th class="px-4 py-3">åç¨±(ä»£è™Ÿ)</th>
                                    <th class="px-4 py-3 text-right">å‡åƒ¹</th>
                                    <th class="px-4 py-3 text-right">ç¾åƒ¹</th>
                                    <th class="px-4 py-3 text-right">è‚¡æ•¸</th>
                                    <th class="px-4 py-3 text-right">æç›Š</th>
                                    <th class="px-4 py-3 text-right">%</th>
                                    <th class="px-4 py-3 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <template v-for="stock in sortedHoldings" :key="stock.id">
                                    <tr @click="toggleExpand(stock.id)" class="hover:bg-gray-800/50 cursor-pointer group transition-colors">
                                        <td class="px-4 py-3"><span :class="getTypeBadge(stock.type)" class="px-2 py-0.5 rounded text-xs border font-normal">{{ stock.type }}</span></td>
                                        <td class="px-4 py-3">
                                            <div class="font-bold text-white text-base">
                                                {{ stock.name }}<span class="text-gray-400 text-sm font-normal ml-1">({{ stock.code }})</span>
                                                <span v-if="expandedSet.has(stock.id)" class="text-xs text-blue-400 ml-2">â–¼ æ˜ç´°</span>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 text-right number-font text-gray-300">{{ formatPrice(stock.cost) }}</td>
                                        <td class="px-4 py-3 text-right number-font font-bold" :class="getPriceColor(stock)">{{ formatPrice(stock.currentPrice) }}</td>
                                        <td class="px-4 py-3 text-right number-font text-gray-300">{{ formatNumber(stock.volume) }}</td>
                                        <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">{{ formatCurrency(calculateUnrealizedPL(stock)) }}</td>
                                        <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">{{ formatPercent(calculateUnrealizedRate(stock)) }}</td>
                                        <td class="px-4 py-3 text-right" @click.stop>
                                            <button @click="editItem('holdings', stock)" class="text-gray-500 hover:text-blue-400 mr-3">âœ</button>
                                            <button @click="deleteItem('holdings', stock.id)" class="text-gray-500 hover:text-red-400">âœ•</button>
                                        </td>
                                    </tr>
                                    <tr v-if="expandedSet.has(stock.id)" class="bg-gray-900/50 border-b border-gray-800">
                                        <td colspan="8" class="p-0">
                                            <div class="p-4 bg-gray-800/30 shadow-inner">
                                                <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">è²·é€²æ˜ç´°</h4>
                                                <table class="w-full text-xs text-gray-300">
                                                    <thead><tr class="text-gray-500 border-b border-gray-700"><th class="py-2 text-left">æ—¥æœŸ</th><th class="py-2 text-right">å–®åƒ¹</th><th class="py-2 text-right">è‚¡æ•¸</th><th class="py-2 text-right">æ‰‹çºŒè²»</th></tr></thead>
                                                    <tbody>
                                                        <tr v-for="(lot, idx) in (stock.lots || [])" :key="idx" class="border-b border-gray-700/50">
                                                            <td class="py-2 number-font">{{ lot.date }}</td><td class="py-2 text-right number-font">{{ formatPrice(lot.price) }}</td><td class="py-2 text-right number-font">{{ formatNumber(lot.volume) }}</td><td class="py-2 text-right number-font">{{ lot.fee }}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'us_stocks'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-3">
                            <span class="w-1 h-6 bg-blue-600 rounded-full"></span> ç¾è‚¡é…ç½®
                            <button @click="refreshPrices('us')" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded border border-gray-700 transition flex items-center gap-2">
                                <span v-if="loadingPrices" class="animate-spin">âŸ³</span>
                                <span>{{ loadingPrices ? 'æ›´æ–°ä¸­...' : 'ğŸ”„ æ›´æ–°ç¾è‚¡' }}</span>
                            </button>
                        </h2>
                        <button @click="openModal('us_stocks')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            + æ–°å¢ç¾è‚¡
                        </button>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">ä»£è™Ÿ</th>
                                    <th class="px-4 py-3">åç¨±</th>
                                    <th class="px-4 py-3 text-right">å‡åƒ¹ (USD)</th>
                                    <th class="px-4 py-3 text-right">ç¾åƒ¹ (USD)</th>
                                    <th class="px-4 py-3 text-right">è‚¡æ•¸</th>
                                    <th class="px-4 py-3 text-right">æç›Š (USD)</th>
                                    <th class="px-4 py-3 text-right">%</th>
                                    <th class="px-4 py-3 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="stock in usHoldings" :key="stock.id" class="hover:bg-gray-800/50">
                                    <td class="px-4 py-3 font-bold text-white">{{ stock.code }}</td>
                                    <td class="px-4 py-3 text-gray-300">{{ stock.name }}</td>
                                    <td class="px-4 py-3 text-right number-font text-gray-300">{{ formatPrice(stock.cost) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getPriceColor(stock)">{{ formatPrice(stock.currentPrice) }}</td>
                                    <td class="px-4 py-3 text-right number-font text-gray-300">{{ formatNumber(stock.volume) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">$ {{ formatPrice(calculateUnrealizedPL(stock)) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">{{ formatPercent(calculateUnrealizedRate(stock)) }}</td>
                                    <td class="px-4 py-3 text-right">
                                        <button @click="editItem('us_stocks', stock)" class="text-gray-500 hover:text-blue-400 mr-3">âœ</button>
                                        <button @click="deleteItem('us_stocks', stock.id)" class="text-gray-500 hover:text-red-400">âœ•</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'gold'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-yellow-500 flex items-center gap-3">
                            <span class="w-1 h-6 bg-yellow-500 rounded-full"></span> é»ƒé‡‘åº«å­˜æ˜ç´°
                        </h2>
                        <button @click="openModal('gold')" class="bg-yellow-600 hover:bg-yellow-500 text-black px-3 py-1.5 rounded text-sm font-bold transition">
                            + æ–°å¢é»ƒé‡‘
                        </button>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">è²·é€²æ—¥æœŸ</th>
                                    <th class="px-4 py-3 text-right">é‡é‡ (g)</th>
                                    <th class="px-4 py-3 text-right">ç¸½æˆæœ¬ (TWD)</th>
                                    <th class="px-4 py-3 text-right">å¹³å‡å–®åƒ¹ (å…ƒ/g)</th>
                                    <th class="px-4 py-3 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="g in goldList" :key="g.id" class="hover:bg-gray-800/50">
                                    <td class="px-4 py-3 number-font text-gray-300">{{ g.date }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold text-yellow-400">{{ formatNumber(g.weight) }}</td>
                                    <td class="px-4 py-3 text-right number-font">{{ formatNumber(g.cost) }}</td>
                                    <td class="px-4 py-3 text-right number-font text-gray-400">{{ formatNumber(g.cost / g.weight) }}</td>
                                    <td class="px-4 py-3 text-right">
                                        <button @click="deleteItem('gold', g.id)" class="text-gray-500 hover:text-red-400 transition">âœ•</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'dashboard' || currentTab === 'history'" class="mb-10">
                     <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl p-6 text-gray-500 text-center" v-if="history.length === 0">æš«ç„¡äº¤æ˜“ç´€éŒ„</div>
                     <div v-else class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                             <thead class="bg-gray-800 text-gray-400 text-xs uppercase"><tr><th class="px-4 py-3">æ—¥æœŸ</th><th class="px-4 py-3">åç¨±</th><th class="px-4 py-3 text-right">ç²åˆ©</th><th class="px-4 py-3 text-right">æ“ä½œ</th></tr></thead>
                             <tbody>
                                 <tr v-for="r in history" :key="r.id" class="hover:bg-gray-800/50">
                                     <td class="px-4 py-3">{{ r.date }}</td>
                                     <td class="px-4 py-3 text-white">{{ r.name }} ({{ r.code }})</td>
                                     <td class="px-4 py-3 text-right font-bold" :class="getColorClass(r.netPL)">{{ formatCurrency(r.netPL) }}</td>
                                     <td class="px-4 py-3 text-right"><button @click="deleteItem('history', r.id)" class="text-red-400">âœ•</button></td>
                                 </tr>
                             </tbody>
                        </table>
                     </div>
                </div>

            </div>

            <transition name="modal">
                <div v-if="showModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                    <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-96 shadow-2xl">
                        <h3 class="text-lg font-bold mb-4 text-white">
                            {{ modalMode === 'add' ? 'æ–°å¢' : 'ç·¨è¼¯' }} 
                            {{ modalType === 'gold' ? 'é»ƒé‡‘' : (modalType === 'us_stocks' ? 'ç¾è‚¡' : 'å°è‚¡') }}
                        </h3>
                        
                        <div class="space-y-3">
                            <div><label class="text-xs text-gray-400">æ—¥æœŸ</label><input v-model="formData.date" type="date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none"></div>

                            <div v-if="modalType === 'gold'" class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="text-xs text-gray-400">é‡é‡ (å…‹)</label><input v-model.number="formData.weight" type="number" min="1" step="1" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none"></div>
                                    <div><label class="text-xs text-gray-400">ç¸½æˆæœ¬ (å…ƒ)</label><input v-model.number="formData.cost" type="number" min="0" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none"></div>
                                </div>
                            </div>

                            <div v-else class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-400">ä»£è™Ÿ</label>
                                        <input v-model="formData.code" @blur="fetchStockName" type="text" placeholder="ä»£è™Ÿ" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white uppercase outline-none">
                                    </div>
                                    <div><label class="text-xs text-gray-400">åç¨±</label><input v-model="formData.name" type="text" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none"></div>
                                </div>

                                <div v-if="modalType === 'holdings'"><label class="text-xs text-gray-400">åˆ†é¡</label><select v-model="formData.type" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none"><option v-for="t in types" :value="t">{{ t }}</option></select></div>

                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="text-xs text-gray-400">åƒ¹æ ¼</label><input v-model.number="formData.price" type="number" min="0" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none"></div>
                                    <div><label class="text-xs text-gray-400">è‚¡æ•¸</label><input v-model.number="formData.volume" type="number" min="1" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none"></div>
                                </div>
                                
                                <div v-if="modalType === 'holdings'"><label class="text-xs text-gray-400">æ‰‹çºŒè²»</label><input v-model.number="formData.fee" type="number" min="0" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none"></div>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button @click="saveData" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold text-sm">å„²å­˜</button>
                            <button @click="showModal = false" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-bold text-sm">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </transition>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const currentTab = ref('holdings');
                const currentTime = ref('');
                const loadingPrices = ref(false);
                const types = ['ç¾è‚¡', 'èè³‡', 'èåˆ¸', 'ç•¶æ²–', 'æœŸè²¨', 'å®šæœŸå®šé¡', 'å€Ÿåˆ¸'];
                
                // Data Refs
                const holdings = ref([]);
                const usHoldings = ref([]); // ç¾è‚¡è³‡æ–™
                const history = ref([]);
                const goldList = ref([]);
                const expandedSet = ref(new Set());

                const showModal = ref(false);
                const modalMode = ref('add');
                const modalType = ref('holdings'); // holdings, us_stocks, gold, history
                const editingId = ref(null);
                const formData = ref({});

                // Firebase Sync
                const initFirebaseSync = () => {
                    const { onSnapshot, collection, query, orderBy } = window.firebaseOps;
                    if(!window.db) return;
                    onSnapshot(collection(window.db, "holdings"), (s) => holdings.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                    onSnapshot(collection(window.db, "us_holdings"), (s) => usHoldings.value = s.docs.map(d => ({ id: d.id, ...d.data() }))); // Sync US Stocks
                    onSnapshot(query(collection(window.db, "history"), orderBy("date", "desc")), (s) => history.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                    onSnapshot(query(collection(window.db, "gold"), orderBy("date", "desc")), (s) => goldList.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                };

                const normalize = (str) => String(str || '').trim().toUpperCase().replace(/\.TW(O)?$/,'');
                const toggleExpand = (id) => { if (expandedSet.value.has(id)) expandedSet.value.delete(id); else expandedSet.value.add(id); };

                // Computed
                const sortedHoldings = computed(() => [...holdings.value].sort((a, b) => normalize(a.code).localeCompare(normalize(b.code))));
                const totalGoldWeight = computed(() => goldList.value.reduce((a, b) => a + (b.weight || 0), 0));
                const totalGoldCost = computed(() => goldList.value.reduce((a, b) => a + (b.cost || 0), 0));
                
                // å°è‚¡è³‡ç”¢
                const totalAssets = computed(() => holdings.value.reduce((a, b) => a + (b.currentPrice * b.volume), 0));
                const totalUnrealizedPL = computed(() => holdings.value.reduce((a, b) => a + ((b.currentPrice * b.volume) - (b.cost * b.volume)), 0));
                const totalUnrealizedPLRate = computed(() => { const c = holdings.value.reduce((a, b) => a + (b.cost * b.volume), 0); return c ? totalUnrealizedPL.value / c : 0; });
                const totalRealizedPL = computed(() => history.value.reduce((a, b) => a + (b.netPL||0), 0));
                const annualROI = computed(() => totalRealizedPL.value / 5000000);

                // ç¾è‚¡è³‡ç”¢ (USD)
                const totalUSAssets = computed(() => usHoldings.value.reduce((a, b) => a + (b.currentPrice * b.volume), 0));
                const totalUSUnrealizedPL = computed(() => usHoldings.value.reduce((a, b) => a + ((b.currentPrice - b.cost) * b.volume), 0));
                const totalUSUnrealizedRate = computed(() => { const c = usHoldings.value.reduce((a, b) => a + (b.cost * b.volume), 0); return c ? totalUSUnrealizedPL.value / c : 0; });

                const saveData = async () => {
                    const { addDoc, updateDoc, collection, doc } = window.firebaseOps;
                    const colName = modalType.value === 'us_stocks' ? 'us_holdings' : modalType.value;
                    let data = { ...formData.value };

                    // â˜… è² æ•¸æª¢æŸ¥ â˜…
                    if (data.price < 0 || data.cost < 0) { alert('åƒ¹æ ¼æˆ–æˆæœ¬ä¸èƒ½ç‚ºè² æ•¸ï¼'); return; }

                    if (colName === 'gold') {
                        data.weight = Math.max(1, Math.round(data.weight)); // å¼·åˆ¶æœ€å° 1g
                        if(modalMode.value === 'add') await addDoc(collection(window.db, 'gold'), data);
                        else await updateDoc(doc(window.db, 'gold', editingId.value), data);
                        showModal.value = false;
                        return;
                    }

                    // è‚¡ç¥¨é‚è¼¯
                    data.price = Number(data.price) || 0;
                    data.volume = Number(data.volume) || 0;
                    data.code = normalize(data.code);
                    if (!data.name) data.name = data.code;

                    // å°è‚¡/ç¾è‚¡ åˆä½µé‚è¼¯
                    if (colName === 'holdings' || colName === 'us_holdings') {
                        const newLot = { date: data.date, price: data.price, volume: data.volume, fee: data.fee || 0 };
                        
                        if (modalMode.value === 'add') {
                            // å°‹æ‰¾é‡è¤‡ (ç¾è‚¡ä¸åˆ† Type, å°è‚¡åˆ† Type)
                            const list = colName === 'holdings' ? holdings.value : usHoldings.value;
                            const existing = list.find(h => normalize(h.code) === data.code && (colName === 'us_holdings' || normalize(h.type) === normalize(data.type)));

                            if (existing) {
                                const oldVol = Number(existing.volume);
                                const newVol = Number(data.volume);
                                const avgCost = ((Number(existing.cost) * oldVol) + (data.price * newVol)) / (oldVol + newVol);
                                await updateDoc(doc(window.db, colName, existing.id), { 
                                    volume: oldVol + newVol, 
                                    cost: avgCost, 
                                    lots: [...(existing.lots || []), newLot] 
                                });
                            } else {
                                data.cost = data.price;
                                data.currentPrice = data.price;
                                data.lots = [newLot];
                                delete data.price;
                                await addDoc(collection(window.db, colName), data);
                            }
                        } else {
                            await updateDoc(doc(window.db, colName, editingId.value), data);
                        }
                    } else {
                        // History
                        if(modalMode.value === 'add') await addDoc(collection(window.db, colName), data);
                        else await updateDoc(doc(window.db, colName, editingId.value), data);
                    }
                    showModal.value = false;
                };

                const refreshPrices = async (target) => {
                    loadingPrices.value = true;
                    // å€åˆ†æ›´æ–°å°è‚¡æˆ–ç¾è‚¡
                    const list = target === 'us' ? usHoldings.value : holdings.value;
                    const collectionName = target === 'us' ? 'us_holdings' : 'holdings';
                    
                    const symbols = [...new Set(list.map(h => h.code))];
                    if(symbols.length === 0) { loadingPrices.value = false; return; }

                    try {
                        const res = await fetch(`/api/quote?symbols=${symbols.join(',')}`);
                        if(!res.ok) throw new Error('API Error');
                        const data = await res.json();
                        const { updateDoc, doc } = window.firebaseOps;
                        
                        for (const stock of list) {
                            const key = normalize(stock.code);
                            // Yahoo API å°ç¾è‚¡æ˜¯ç›´æ¥å›å‚³ä»£è™Ÿ (å¦‚ AAPL)ï¼Œå°è‚¡æ˜¯ 2330.TW
                            const stockData = data[key] || data[`${key}.TW`]; 
                            if (stockData && stockData.price) {
                                await updateDoc(doc(window.db, collectionName, stock.id), { currentPrice: stockData.price });
                            }
                        }
                    } catch (e) { alert("æ›´æ–°å¤±æ•—"); }
                    loadingPrices.value = false;
                };

                const fetchStockName = async () => {
                    const code = formData.value.code;
                    if (!code) return;
                    // ç¾è‚¡ä»£è™Ÿå¯èƒ½è¼ƒçŸ­ï¼Œä¸é™åˆ¶é•·åº¦
                    try {
                        const res = await fetch(`/api/quote?symbols=${code}`);
                        const data = await res.json();
                        const key = normalize(code);
                        const stockData = data[key] || data[`${key}.TW`]; 
                        if (stockData && stockData.name) {
                            formData.value.name = stockData.name;
                            if (modalMode.value === 'add' && !formData.value.price) formData.value.price = stockData.price;
                        }
                    } catch (e) { console.error(e); }
                };

                // UI Helpers
                const openModal = (type) => { 
                    modalType.value = type; modalMode.value = 'add'; 
                    formData.value = { date: new Date().toISOString().split('T')[0], type: 'ç¾è‚¡', price: 0, volume: type==='us_stocks'?1:1000, weight: 1, cost: 0 }; 
                    showModal.value = true; 
                };
                const editItem = (type, item) => { 
                    modalType.value = type; modalMode.value = 'edit'; editingId.value = item.id; 
                    formData.value = { ...item }; 
                    if(type.includes('holdings')) formData.value.price = item.cost; 
                    showModal.value = true; 
                };
                const deleteItem = async (type, id) => { 
                    // ä¿®æ­£ type å°æ‡‰
                    const col = type === 'us_stocks' ? 'us_holdings' : type;
                    if(confirm('ç¢ºå®šåˆªé™¤?')) await window.firebaseOps.deleteDoc(window.firebaseOps.doc(window.db, col, id)); 
                };
                const getTabClass = (tab) => currentTab.value === tab ? 'bg-gray-800 text-white shadow' : 'text-gray-400 hover:bg-gray-800/50';
                
                const formatCurrency = (v) => new Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD', minimumFractionDigits:0}).format(v||0);
                const formatNumber = (v) => new Intl.NumberFormat('zh-TW').format(v||0);
                const formatPrice = (v) => new Intl.NumberFormat('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v||0);
                const formatPercent = (v) => ((v||0) * 100).toFixed(2) + '%';
                const getColorClass = (v) => v > 0 ? 'text-up' : (v < 0 ? 'text-down' : 'text-gray-400');
                const getPriceColor = (s) => s.currentPrice > s.cost ? 'text-up' : (s.currentPrice < s.cost ? 'text-down' : 'text-white');
                const getTypeBadge = (t) => { const m = {'ç¾è‚¡':'border-blue-800 text-blue-400', 'èè³‡':'border-orange-800 text-orange-400', 'æœŸè²¨':'border-red-800 text-red-400'}; return m[t] ? `bg-${m[t].split(' ')[0].replace('border-','')} ${m[t]}` : 'bg-gray-800 text-gray-300'; };
                
                const calculateUnrealizedPL = (s) => (s.currentPrice * s.volume) - (s.cost * s.volume);
                const calculateUnrealizedRate = (s) => s.cost ? (s.currentPrice - s.cost) / s.cost : 0;

                onMounted(() => {
                    window.addEventListener('firebase-ready', () => { initFirebaseSync(); });
                    if (window.db) initFirebaseSync();
                    setInterval(() => currentTime.value = new Date().toLocaleString('zh-TW', {hour12:false}), 1000);
                });

                return { 
                    currentTab, currentTime, holdings, usHoldings, sortedHoldings, history, goldList, showModal, modalMode, modalType, formData, types, 
                    totalAssets, totalUnrealizedPL, totalUnrealizedPLRate, totalRealizedPL, annualROI, 
                    totalUSAssets, totalUSUnrealizedPL, totalUSUnrealizedRate, totalGoldWeight, totalGoldCost,
                    loadingPrices, expandedSet,
                    openModal, editItem, deleteItem, saveData, refreshPrices, fetchStockName, toggleExpand, getTabClass,
                    formatCurrency, formatNumber, formatPrice, formatPercent, getColorClass, getPriceColor, getTypeBadge, calculateUnrealizedPL, calculateUnrealizedRate 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>