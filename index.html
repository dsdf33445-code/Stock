<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA TRADER Pro - Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        async function initApp() {
            try {
                // 1. æŠ“å–ç’°å¢ƒè®Šæ•¸
                const res = await fetch('/api/config');
                if (!res.ok) throw new Error('ç„¡æ³•è®€å–è¨­å®š');
                const firebaseConfig = await res.json();

                // 2. åˆå§‹åŒ–
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.firebaseOps = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp };
                
                // 3. ç™¼é€å°±ç·’è¨Šè™Ÿ
                window.dispatchEvent(new Event('firebase-ready'));
                console.log("Firebase initialized");
            } catch (e) {
                console.error("Init Error:", e);
                alert("ç³»çµ±æç¤ºï¼šç„¡æ³•è®€å–ç’°å¢ƒè®Šæ•¸ï¼Œè«‹ç¢ºèª Vercel è¨­å®šæˆ– api/config.js æ˜¯å¦æ­£ç¢ºã€‚");
            }
        }
        initApp();
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter'], mono: ['JetBrains Mono'] },
                    colors: {
                        gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' },
                        up: '#ef4444',   
                        down: '#22c55e', 
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .number-font { font-family: 'JetBrains Mono', monospace; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 h-screen overflow-hidden flex flex-col font-sans">

    <div id="app" v-cloak class="flex h-full">
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <h1 class="text-xl font-bold tracking-wider text-blue-400">ALPHA TRADER</h1>
                <p class="text-xs text-gray-500 mt-1">Cloud Sync Enabled</p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button v-for="tab in ['dashboard', 'holdings', 'history']" :key="tab"
                    @click="currentTab = tab" 
                    :class="currentTab === tab ? 'bg-blue-600/20 text-blue-400' : 'text-gray-400 hover:bg-gray-800'"
                    class="w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors capitalize flex items-center">
                    {{ tab === 'dashboard' ? 'ç¸½è¦½å„€è¡¨æ¿' : tab === 'holdings' ? 'åº«å­˜æŒè‚¡' : 'å·²å¯¦ç¾æç›Š' }}
                </button>
            </nav>
            <div class="p-4 border-t border-gray-800 text-xs text-gray-500 text-center">
                {{ currentTime }}
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            <header class="bg-gray-900/50 border-b border-gray-800 p-6 backdrop-blur-sm grid grid-cols-4 gap-6">
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-xs mb-1">ç¸½è³‡ç”¢</div>
                    <div class="text-2xl font-bold number-font">{{ formatCurrency(totalAssets) }}</div>
                </div>
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-xs mb-1">æœªå¯¦ç¾æç›Š</div>
                    <div :class="getColorClass(totalUnrealizedPL)" class="text-2xl font-bold number-font">
                        {{ formatCurrency(totalUnrealizedPL) }}
                        <span class="text-sm ml-2">({{ formatPercent(totalUnrealizedPLRate) }})</span>
                    </div>
                </div>
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-xs mb-1">å·²å¯¦ç¾æç›Š</div>
                    <div :class="getColorClass(totalRealizedPL)" class="text-2xl font-bold number-font">{{ formatCurrency(totalRealizedPL) }}</div>
                </div>
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-xs mb-1">å¹´åº¦å ±é…¬ç‡</div>
                    <div :class="getColorClass(annualROI)" class="text-2xl font-bold number-font">{{ formatPercent(annualROI) }}</div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-6 relative">
                <div v-if="currentTab === 'dashboard' || currentTab === 'holdings'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-3">
                            <span class="w-1 h-6 bg-blue-500 rounded-full"></span> åº«å­˜æŒè‚¡
                            <button @click="refreshPrices" class="text-xs bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded border border-gray-700 transition flex items-center gap-1">
                                <span v-if="loadingPrices" class="animate-spin">âŸ³</span>
                                <span>{{ loadingPrices ? 'æ›´æ–°ä¸­...' : 'ğŸ”„ æ›´æ–°è‚¡åƒ¹' }}</span>
                            </button>
                        </h2>
                        <button @click="openModal('holdings')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            + æ–°å¢æŒè‚¡
                        </button>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">åˆ†é¡</th>
                                    <th class="px-4 py-3">åç¨±(ä»£è™Ÿ)</th>
                                    <th class="px-4 py-3 text-right">æˆæœ¬</th>
                                    <th class="px-4 py-3 text-right">ç¾åƒ¹</th>
                                    <th class="px-4 py-3 text-right">è‚¡æ•¸</th>
                                    <th class="px-4 py-3 text-right">æç›Š</th>
                                    <th class="px-4 py-3 text-right">%</th>
                                    <th class="px-4 py-3 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="stock in holdings" :key="stock.id" class="hover:bg-gray-800/50 group">
                                    <td class="px-4 py-3">
                                        <span :class="getTypeBadge(stock.type)" class="px-2 py-0.5 rounded text-xs border font-normal">{{ stock.type }}</span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-bold text-white text-base">
                                            {{ stock.name }}<span class="text-gray-400 text-sm font-normal ml-1">({{ stock.code }})</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-right number-font text-gray-300">{{ formatNumber(stock.cost) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getPriceColor(stock)">{{ formatNumber(stock.currentPrice) }}</td>
                                    <td class="px-4 py-3 text-right number-font text-gray-300">{{ formatNumber(stock.volume) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">
                                        {{ formatCurrency(calculateUnrealizedPL(stock)) }}
                                    </td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">
                                        {{ formatPercent(calculateUnrealizedRate(stock)) }}
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <button @click="editItem('holdings', stock)" class="text-gray-500 hover:text-blue-400 mr-3 transition">âœ</button>
                                        <button @click="deleteItem('holdings', stock.id)" class="text-gray-500 hover:text-red-400 transition">âœ•</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'dashboard' || currentTab === 'history'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-3">
                            <span class="w-1 h-6 bg-purple-500 rounded-full"></span> å·²å¯¦ç¾æç›Š
                        </h2>
                        <button @click="openModal('history')" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            + æ–°å¢ç´€éŒ„
                        </button>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">æ—¥æœŸ</th>
                                    <th class="px-4 py-3">åç¨±(ä»£è™Ÿ)</th>
                                    <th class="px-4 py-3 text-right">ç²åˆ©</th>
                                    <th class="px-4 py-3 text-right">%</th>
                                    <th class="px-4 py-3 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="record in history" :key="record.id" class="hover:bg-gray-800/50">
                                    <td class="px-4 py-3 text-gray-400 number-font text-xs">{{ record.date }}</td>
                                    <td class="px-4 py-3">
                                        <span class="font-bold text-white">{{ record.name }}</span>
                                        <span class="text-gray-500 text-xs ml-1">({{ record.code }})</span>
                                        <span :class="getTypeBadge(record.type)" class="ml-2 text-[10px] px-1 rounded border">{{ record.type }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(record.netPL)">{{ formatCurrency(record.netPL) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(record.netPL)">{{ formatPercent(record.roi) }}</td>
                                    <td class="px-4 py-3 text-right">
                                        <button @click="editItem('history', record)" class="text-gray-500 hover:text-blue-400 mr-3">âœ</button>
                                        <button @click="deleteItem('history', record.id)" class="text-gray-500 hover:text-red-400">âœ•</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <transition name="modal">
                <div v-if="showModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                    <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-96 shadow-2xl">
                        <h3 class="text-lg font-bold mb-4 text-white">{{ modalMode === 'add' ? 'æ–°å¢' : 'ç·¨è¼¯' }} {{ modalType === 'holdings' ? 'åº«å­˜' : 'ç´€éŒ„' }}</h3>
                        <div class="space-y-3">
                            <div v-if="modalType === 'history'">
                                <label class="text-xs text-gray-400">æ—¥æœŸ</label>
                                <input v-model="formData.date" type="date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">è‚¡ç¥¨ä»£è™Ÿ</label>
                                <div class="flex gap-2">
                                    <input v-model="formData.code" @blur="fetchStockName" type="text" placeholder="ex: 2330" class="flex-1 bg-gray-800 border border-gray-700 rounded p-2 text-white uppercase focus:border-blue-500 outline-none">
                                    <button @click="fetchStockName" class="bg-gray-700 hover:bg-gray-600 px-3 rounded text-white text-xs border border-gray-600">
                                        <span v-if="fetchingName" class="animate-spin block">âŸ³</span>
                                        <span v-else>ğŸ”</span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">è‚¡ç¥¨åç¨±</label>
                                <input v-model="formData.name" type="text" placeholder="è‡ªå‹•å¸¶å…¥" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">åˆ†é¡</label>
                                <select v-model="formData.type" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none">
                                    <option v-for="t in types" :value="t">{{ t }}</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-gray-400">{{ modalType === 'holdings' ? 'æˆæœ¬å‡åƒ¹' : 'æˆäº¤åƒ¹' }}</label>
                                    <input v-model.number="formData.price" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">è‚¡æ•¸</label>
                                    <input v-model.number="formData.volume" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white outline-none focus:border-blue-500">
                                </div>
                            </div>
                            <div v-if="modalType === 'history'" class="pt-2 border-t border-gray-800 space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="text-xs text-gray-400">æ·¨æç›Š</label><input v-model.number="formData.netPL" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white font-bold"></div>
                                    <div><label class="text-xs text-gray-400">å ±é…¬ç‡</label><input v-model.number="formData.roi" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div>æ‰‹çºŒè²» <input v-model.number="formData.fee" class="bg-gray-800 w-full border border-gray-700 rounded p-1 text-right"></div>
                                    <div>ç¨… <input v-model.number="formData.tax" class="bg-gray-800 w-full border border-gray-700 rounded p-1 text-right"></div>
                                </div>
                                <button @click="autoCalculate" class="w-full text-xs text-blue-400 border border-blue-900 rounded py-1 hover:bg-blue-900/30">âš¡ è©¦ç®—è²»ç”¨ (è³£å‡º)</button>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button @click="saveData" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold text-sm transition">å„²å­˜</button>
                            <button @click="showModal = false" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-bold text-sm transition">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </transition>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const currentTab = ref('dashboard');
                const currentTime = ref('');
                const loadingPrices = ref(false);
                const fetchingName = ref(false);
                const types = ['ç¾è‚¡', 'èè³‡', 'èåˆ¸', 'ç•¶æ²–', 'æœŸè²¨', 'å®šæœŸå®šé¡', 'å€Ÿåˆ¸'];
                const holdings = ref([]);
                const history = ref([]);
                
                const showModal = ref(false);
                const modalMode = ref('add');
                const modalType = ref('holdings');
                const editingId = ref(null);
                const formData = ref({});

                // Firebase Sync
                const initFirebaseSync = () => {
                    const { onSnapshot, collection, query, orderBy } = window.firebaseOps;
                    if(!window.db) return;
                    onSnapshot(collection(window.db, "holdings"), (s) => holdings.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                    onSnapshot(query(collection(window.db, "history"), orderBy("date", "desc")), (s) => history.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                };

                // è‡ªå‹•æŠ“å–åç¨±
                const fetchStockName = async () => {
                    const code = formData.value.code;
                    if (!code || code.length < 3) return;
                    fetchingName.value = true;
                    try {
                        const res = await fetch(`/api/quote?symbols=${code}`);
                        const data = await res.json();
                        const key = code.toUpperCase();
                        // å˜—è©¦åŒ¹é…
                        const stockData = data[key] || data[`${key}.TW`]; 
                        if (stockData && stockData.name) {
                            formData.value.name = stockData.name;
                            if (modalMode.value === 'add' && !formData.value.price) formData.value.price = stockData.price;
                        }
                    } catch (e) { console.error("ç„¡æ³•æŠ“å–åç¨±", e); }
                    fetchingName.value = false;
                };

                // æ›´æ–°è‚¡åƒ¹
                const refreshPrices = async () => {
                    loadingPrices.value = true;
                    const symbols = [...new Set(holdings.value.map(h => h.code))];
                    if(symbols.length === 0) { loadingPrices.value = false; return; }
                    try {
                        const res = await fetch(`/api/quote?symbols=${symbols.join(',')}`);
                        const data = await res.json();
                        const { updateDoc, doc } = window.firebaseOps;
                        for (const stock of holdings.value) {
                            const key = String(stock.code).toUpperCase();
                            const stockData = data[key] || data[`${key}.TW`]; 
                            if (stockData && stockData.price) {
                                await updateDoc(doc(window.db, "holdings", stock.id), { currentPrice: stockData.price, name: stockData.name || stock.name });
                            }
                        }
                    } catch (e) { alert("âš ï¸ æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API"); }
                    loadingPrices.value = false;
                };

                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ï¼šå„²å­˜é‚è¼¯ (è¶…ç´šå¯¬å®¹æ¯”å°æ¨¡å¼) â˜…â˜…â˜…
                const saveData = async () => {
                    const { addDoc, updateDoc, collection, doc } = window.firebaseOps;
                    const colName = modalType.value;
                    let data = { ...formData.value };

                    // 1. è³‡æ–™æ¸…æ´—
                    data.price = Number(data.price) || 0;
                    data.volume = Number(data.volume) || 0;
                    // å¼·åˆ¶è½‰å¤§å¯«ä¸¦ç§»é™¤ç©ºç™½ï¼Œç¢ºä¿æ ¼å¼çµ±ä¸€
                    const normalizedInputCode = String(data.code || '').trim().toUpperCase();
                    data.code = normalizedInputCode;

                    if (!data.name) data.name = data.code;

                    if (colName === 'holdings') {
                        data.cost = data.price;
                        if (!data.currentPrice) data.currentPrice = data.cost;
                        delete data.price;

                        if (modalMode.value === 'add') {
                            // â˜…â˜…â˜… æ¯”å°é‚è¼¯ï¼šå¼·åˆ¶è½‰å­—ä¸²ã€å»ç©ºç™½ã€è½‰å¤§å¯«ï¼Œå†æ¯”å° â˜…â˜…â˜…
                            const existing = holdings.value.find(h => {
                                const dbCode = String(h.code || '').trim().toUpperCase();
                                return dbCode === normalizedInputCode && h.type === data.type;
                            });

                            if (existing) {
                                // åŸ·è¡Œåˆä½µ
                                const oldVol = Number(existing.volume);
                                const newVol = Number(data.volume);
                                // åŠ æ¬Šå¹³å‡æˆæœ¬
                                const avgCost = ((Number(existing.cost) * oldVol) + (data.cost * newVol)) / (oldVol + newVol);
                                
                                await updateDoc(doc(window.db, colName, existing.id), { 
                                    volume: oldVol + newVol, 
                                    cost: avgCost, 
                                    currentPrice: data.currentPrice 
                                });
                                alert(`âœ… åˆä½µæˆåŠŸï¼\nå·²å°‡ ${newVol} è‚¡ä½µå…¥ç¾æœ‰æŒè‚¡ã€‚\næ–°å¹³å‡æˆæœ¬: ${avgCost.toFixed(2)}`);
                            } else {
                                // æ–°å¢
                                await addDoc(collection(window.db, colName), data);
                                alert(`âœ… æ–°å¢æˆåŠŸï¼\nå·²å»ºç«‹æ–°æŒè‚¡: ${data.name}`);
                            }
                        } else {
                            // ç·¨è¼¯æ¨¡å¼
                            await updateDoc(doc(window.db, colName, editingId.value), data);
                        }
                    } else {
                        // History æ¨¡å¼ (ä¸åˆä½µ)
                        data.fee = Number(data.fee)||0; data.tax = Number(data.tax)||0; data.netPL = Number(data.netPL)||0; data.roi = Number(data.roi)||0;
                        if (modalMode.value === 'add') await addDoc(collection(window.db, colName), data);
                        else await updateDoc(doc(window.db, colName, editingId.value), data);
                    }
                    showModal.value = false;
                };

                // UI Helpers
                const openModal = (type) => { modalType.value = type; modalMode.value = 'add'; formData.value = { date: new Date().toISOString().split('T')[0], type: 'ç¾è‚¡', price: 0, volume: 1000 }; showModal.value = true; };
                const editItem = (type, item) => { modalType.value = type; modalMode.value = 'edit'; editingId.value = item.id; formData.value = { ...item }; if(type==='holdings') formData.value.price=item.cost; showModal.value = true; };
                const deleteItem = async (type, id) => { if(confirm('ç¢ºå®šåˆªé™¤?')) await window.firebaseOps.deleteDoc(window.firebaseOps.doc(window.db, type, id)); };
                const autoCalculate = () => { const p = formData.value.price; const v = formData.value.volume; formData.value.fee = Math.floor(p*v*0.001425); formData.value.tax = Math.floor(p*v*0.003); alert('å·²å¡«å…¥è²»ç”¨'); };
                
                // Formatter & Colors
                const formatCurrency = (v) => new Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD', minimumFractionDigits:0}).format(v||0);
                const formatNumber = (v) => new Intl.NumberFormat('zh-TW').format(v||0);
                const formatPercent = (v) => ((v||0) * 100).toFixed(2) + '%';
                const getColorClass = (v) => v > 0 ? 'text-up' : (v < 0 ? 'text-down' : 'text-gray-400');
                const getPriceColor = (s) => s.currentPrice > s.cost ? 'text-up' : (s.currentPrice < s.cost ? 'text-down' : 'text-white');
                const getTypeBadge = (t) => { const m = {'ç¾è‚¡':'border-blue-800 text-blue-400', 'èè³‡':'border-orange-800 text-orange-400', 'æœŸè²¨':'border-red-800 text-red-400'}; return m[t] ? `bg-${m[t].split(' ')[0].replace('border-','')} ${m[t]}` : 'bg-gray-800 text-gray-300'; };
                const calculateUnrealizedPL = (s) => (s.currentPrice * s.volume) - (s.cost * s.volume);
                const calculateUnrealizedRate = (s) => s.cost ? (s.currentPrice - s.cost) / s.cost : 0;
                
                const totalAssets = computed(() => holdings.value.reduce((a, b) => a + (b.currentPrice * b.volume), 0));
                const totalUnrealizedPL = computed(() => holdings.value.reduce((a, b) => a + calculateUnrealizedPL(b), 0));
                const totalUnrealizedPLRate = computed(() => { const cost = holdings.value.reduce((a, b) => a + (b.cost * b.volume), 0); return cost ? totalUnrealizedPL.value / cost : 0; });
                const totalRealizedPL = computed(() => history.value.reduce((a, b) => a + (b.netPL||0), 0));
                const annualROI = computed(() => totalRealizedPL.value / 5000000);

                onMounted(() => {
                    window.addEventListener('firebase-ready', () => { initFirebaseSync(); });
                    if (window.db) initFirebaseSync();
                    setInterval(() => currentTime.value = new Date().toLocaleString('zh-TW', {hour12:false}), 1000);
                });

                return { 
                    currentTab, currentTime, holdings, history, showModal, modalMode, modalType, formData, types, 
                    totalAssets, totalUnrealizedPL, totalUnrealizedPLRate, totalRealizedPL, annualROI, loadingPrices, fetchingName,
                    openModal, editItem, deleteItem, saveData, autoCalculate, refreshPrices, fetchStockName,
                    formatCurrency, formatNumber, formatPercent, getColorClass, getPriceColor, getTypeBadge, calculateUnrealizedPL, calculateUnrealizedRate 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>