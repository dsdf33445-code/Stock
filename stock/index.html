<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA TRADER Pro - Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â˜…â˜…â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Firebase è¨­å®š â˜…â˜…â˜…
        const firebaseConfig = {
  	apiKey: "AIzaSyCV5sUAZz5Lo226gv2ryuJeCLlnRC5KQrY",
  	authDomain: "stock-12290.firebaseapp.com",
  	projectId: "stock-12290",
  	storageBucket: "stock-12290.firebasestorage.app",
  	messagingSenderId: "586421910135",
  	appId: "1:586421910135:web:df8c590c25e733e1392472",
  	measurementId: "G-XR417P8PEN"
	};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db; // æ›è¼‰åˆ° window ä¾› Vue ä½¿ç”¨
        window.firebaseOps = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter'], mono: ['JetBrains Mono'] },
                    colors: { gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' }, up: '#ef4444', down: '#22c55e' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .number-font { font-family: 'JetBrains Mono', monospace; }
        [v-cloak] { display: none; }
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 h-screen overflow-hidden flex flex-col font-sans">

    <div id="app" v-cloak class="flex h-full">
        
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <h1 class="text-xl font-bold tracking-wider text-blue-400">ALPHA TRADER</h1>
                <p class="text-xs text-gray-500 mt-1">Cloud Sync Enabled</p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button v-for="tab in ['dashboard', 'holdings', 'history']" :key="tab"
                    @click="currentTab = tab" 
                    :class="currentTab === tab ? 'bg-blue-600/20 text-blue-400' : 'text-gray-400 hover:bg-gray-800'"
                    class="w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors capitalize flex items-center">
                    {{ tab === 'dashboard' ? 'ç¸½è¦½å„€è¡¨æ¿' : tab === 'holdings' ? 'åº«å­˜æŒè‚¡' : 'å·²å¯¦ç¾æç›Š' }}
                </button>
            </nav>
            <div class="p-4 border-t border-gray-800 text-xs text-gray-500 text-center">
                {{ currentTime }} <br> Firestore é€£ç·šä¸­
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            
            <header class="bg-gray-900/50 border-b border-gray-800 p-6 backdrop-blur-sm grid grid-cols-4 gap-6">
                <div class="stat-card">
                    <div class="text-gray-400 text-xs mb-1">ç¸½è³‡ç”¢</div>
                    <div class="text-2xl font-bold number-font">{{ formatCurrency(totalAssets) }}</div>
                </div>
                <div class="stat-card">
                    <div class="text-gray-400 text-xs mb-1">æœªå¯¦ç¾æç›Š</div>
                    <div :class="getColorClass(totalUnrealizedPL)" class="text-2xl font-bold number-font">
                        {{ formatCurrency(totalUnrealizedPL) }}
                        <span class="text-sm ml-2">({{ formatPercent(totalUnrealizedPLRate) }})</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="text-gray-400 text-xs mb-1">å·²å¯¦ç¾æç›Š</div>
                    <div :class="getColorClass(totalRealizedPL)" class="text-2xl font-bold number-font">{{ formatCurrency(totalRealizedPL) }}</div>
                </div>
                <div class="stat-card">
                    <div class="text-gray-400 text-xs mb-1">å¹´åº¦å ±é…¬ç‡</div>
                    <div :class="getColorClass(annualROI)" class="text-2xl font-bold number-font">{{ formatPercent(annualROI) }}</div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-6 relative">
                
                <div v-if="currentTab === 'dashboard' || currentTab === 'holdings'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-3">
                            <span class="w-1 h-6 bg-blue-500 rounded-full"></span> åº«å­˜æŒè‚¡
                            <button @click="refreshPrices" class="text-xs bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded border border-gray-700 transition">
                                <span v-if="loadingPrices">æ›´æ–°ä¸­...</span>
                                <span v-else>ğŸ”„ æ›´æ–°è‚¡åƒ¹</span>
                            </button>
                        </h2>
                        <button @click="openModal('holdings')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition flex items-center">
                            + æ–°å¢æŒè‚¡
                        </button>
                    </div>

                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">æ“ä½œ</th>
                                    <th class="px-4 py-3">åˆ†é¡</th>
                                    <th class="px-4 py-3">ä»£è™Ÿ/åç¨±</th>
                                    <th class="px-4 py-3 text-right">æˆæœ¬å‡åƒ¹</th>
                                    <th class="px-4 py-3 text-right">ç¾åƒ¹</th>
                                    <th class="px-4 py-3 text-right">è‚¡æ•¸</th>
                                    <th class="px-4 py-3 text-right">æç›Š</th>
                                    <th class="px-4 py-3 text-right">å ±é…¬ç‡</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="stock in holdings" :key="stock.id" class="hover:bg-gray-800/50 group">
                                    <td class="px-4 py-3 flex gap-2">
                                        <button @click="editItem('holdings', stock)" class="text-gray-500 hover:text-blue-400">âœ</button>
                                        <button @click="deleteItem('holdings', stock.id)" class="text-gray-500 hover:text-red-400">âœ•</button>
                                    </td>
                                    <td class="px-4 py-3"><span :class="getTypeBadge(stock.type)" class="px-2 py-0.5 rounded text-xs border">{{ stock.type }}</span></td>
                                    <td class="px-4 py-3">
                                        <div class="font-bold text-white">{{ stock.code }}</div>
                                        <div class="text-gray-500 text-xs">{{ stock.name }}</div>
                                    </td>
                                    <td class="px-4 py-3 text-right number-font">{{ formatNumber(stock.cost) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getPriceColor(stock)">{{ formatNumber(stock.currentPrice) }}</td>
                                    <td class="px-4 py-3 text-right number-font">{{ formatNumber(stock.volume) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">
                                        {{ formatCurrency(calculateUnrealizedPL(stock)) }}
                                    </td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(calculateUnrealizedPL(stock))">
                                        {{ formatPercent(calculateUnrealizedRate(stock)) }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="currentTab === 'dashboard' || currentTab === 'history'" class="mb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center gap-3">
                            <span class="w-1 h-6 bg-purple-500 rounded-full"></span> å·²å¯¦ç¾æç›Š
                        </h2>
                        <button @click="openModal('history')" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            + æ–°å¢ç´€éŒ„
                        </button>
                    </div>

                    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">æ“ä½œ</th>
                                    <th class="px-4 py-3">æ—¥æœŸ</th>
                                    <th class="px-4 py-3">ä»£è™Ÿ</th>
                                    <th class="px-4 py-3 text-right">æˆäº¤åƒ¹</th>
                                    <th class="px-4 py-3 text-right">è‚¡æ•¸</th>
                                    <th class="px-4 py-3 text-right">æ‰‹çºŒè²»</th>
                                    <th class="px-4 py-3 text-right">äº¤æ˜“ç¨…</th>
                                    <th class="px-4 py-3 text-right">æ·¨æç›Š</th>
                                    <th class="px-4 py-3 text-right">%</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <tr v-for="record in history" :key="record.id" class="hover:bg-gray-800/50">
                                    <td class="px-4 py-3 flex gap-2">
                                        <button @click="editItem('history', record)" class="text-gray-500 hover:text-blue-400">âœ</button>
                                        <button @click="deleteItem('history', record.id)" class="text-gray-500 hover:text-red-400">âœ•</button>
                                    </td>
                                    <td class="px-4 py-3 text-gray-400 number-font text-xs">{{ record.date }}</td>
                                    <td class="px-4 py-3">
                                        <span class="font-bold text-white">{{ record.code }}</span>
                                        <span :class="getTypeBadge(record.type)" class="ml-2 text-[10px] px-1 rounded border">{{ record.type }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-right number-font">{{ formatNumber(record.price) }}</td>
                                    <td class="px-4 py-3 text-right number-font">{{ formatNumber(record.volume) }}</td>
                                    <td class="px-4 py-3 text-right text-gray-500 number-font">{{ record.fee }}</td>
                                    <td class="px-4 py-3 text-right text-gray-500 number-font">{{ record.tax }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(record.netPL)">{{ formatCurrency(record.netPL) }}</td>
                                    <td class="px-4 py-3 text-right number-font font-bold" :class="getColorClass(record.netPL)">{{ formatPercent(record.roi) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <transition name="modal">
                <div v-if="showModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                    <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-96 shadow-2xl">
                        <h3 class="text-lg font-bold mb-4 text-white">{{ modalMode === 'add' ? 'æ–°å¢' : 'ç·¨è¼¯' }} {{ modalType === 'holdings' ? 'åº«å­˜' : 'ç´€éŒ„' }}</h3>
                        
                        <div class="space-y-3">
                            <div v-if="modalType === 'history'">
                                <label class="text-xs text-gray-400">äº¤æ˜“æ—¥æœŸ</label>
                                <input v-model="formData.date" type="date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-gray-400">ä»£è™Ÿ</label>
                                    <input v-model="formData.code" type="text" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none uppercase">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">åç¨±</label>
                                    <input v-model="formData.name" type="text" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none">
                                </div>
                            </div>

                            <div>
                                <label class="text-xs text-gray-400">åˆ†é¡</label>
                                <select v-model="formData.type" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm outline-none">
                                    <option v-for="t in types" :value="t">{{ t }}</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-gray-400">{{ modalType === 'holdings' ? 'æˆæœ¬å‡åƒ¹' : 'æˆäº¤åƒ¹' }}</label>
                                    <input v-model.number="formData.price" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm outline-none">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">è‚¡æ•¸</label>
                                    <input v-model.number="formData.volume" type="number" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm outline-none">
                                </div>
                            </div>

                            <div v-if="modalType === 'history'" class="pt-2 border-t border-gray-800">
                                <div class="flex justify-between text-xs text-gray-400 mb-2">
                                    <span>æ‰‹çºŒè²»: <input v-model.number="formData.fee" class="bg-gray-800 w-16 text-right"></span>
                                    <span>ç¨…: <input v-model.number="formData.tax" class="bg-gray-800 w-16 text-right"></span>
                                </div>
                                <div class="flex justify-between text-xs text-gray-400">
                                    <span>æç›Š: <input v-model.number="formData.netPL" class="bg-gray-800 w-16 text-right"></span>
                                    <span>ROI: <input v-model.number="formData.roi" class="bg-gray-800 w-16 text-right"></span>
                                </div>
                                <button @click="autoCalculate" class="w-full mt-2 text-xs text-blue-400 border border-blue-900 rounded py-1 hover:bg-blue-900/30">âš¡ è‡ªå‹•è©¦ç®—è²»ç”¨èˆ‡æç›Š</button>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button @click="saveData" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold text-sm">å„²å­˜</button>
                            <button @click="showModal = false" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-bold text-sm">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </transition>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const db = ref(null);
                const currentTab = ref('dashboard');
                const currentTime = ref('');
                const loadingPrices = ref(false);
                const types = ['ç¾è‚¡', 'èè³‡', 'èåˆ¸', 'ç•¶æ²–', 'æœŸè²¨', 'å®šæœŸå®šé¡', 'å€Ÿåˆ¸'];

                const holdings = ref([]);
                const history = ref([]);

                // Modal ç‹€æ…‹
                const showModal = ref(false);
                const modalMode = ref('add'); // 'add' or 'edit'
                const modalType = ref('holdings'); // 'holdings' or 'history'
                const editingId = ref(null);
                const formData = ref({});

                // ----------------- Firebase Sync -----------------
                const initFirebaseSync = () => {
                    const { onSnapshot, collection, query, orderBy, db: firestoreDb } = window.firebaseOps;
                    if(!firestoreDb) return; // Wait for load

                    // ç›£è½æŒè‚¡
                    onSnapshot(collection(window.db, "holdings"), (snapshot) => {
                        holdings.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    // ç›£è½æ­·å² (æŒ‰æ—¥æœŸæ’åº)
                    const historyq = query(collection(window.db, "history"), orderBy("date", "desc"));
                    onSnapshot(historyq, (snapshot) => {
                        history.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                };

                // ----------------- CRUD -----------------
                const openModal = (type) => {
                    modalType.value = type;
                    modalMode.value = 'add';
                    formData.value = { 
                        date: new Date().toISOString().split('T')[0], 
                        type: 'ç¾è‚¡', fee: 0, tax: 0, netPL: 0, roi: 0, currentPrice: 0 // Default values
                    };
                    showModal.value = true;
                };

                const editItem = (type, item) => {
                    modalType.value = type;
                    modalMode.value = 'edit';
                    editingId.value = item.id;
                    formData.value = { ...item };
                    // ç‚ºäº†æ¬„ä½å°æ‡‰ï¼Œå¦‚æœæ˜¯åº«å­˜ï¼ŒæŠŠ cost æ˜ å°„åˆ° price
                    if(type === 'holdings') {
                        formData.value.price = item.cost;
                    }
                    showModal.value = true;
                };

                const deleteItem = async (type, id) => {
                    if(!confirm('ç¢ºå®šåˆªé™¤?')) return;
                    const { deleteDoc, doc } = window.firebaseOps;
                    await deleteDoc(doc(window.db, type, id));
                };

                const saveData = async () => {
                    const { addDoc, updateDoc, collection, doc } = window.firebaseOps;
                    const colName = modalType.value;
                    
                    let data = { ...formData.value };
                    // è½‰æ›æ•¸å€¼
                    data.price = Number(data.price);
                    data.volume = Number(data.volume);

                    if (colName === 'holdings') {
                        data.cost = data.price; // Mapping back
                        // å¦‚æœæ²’æœ‰ç¾åƒ¹ï¼Œå…ˆæš«æ™‚ç­‰æ–¼æˆæœ¬
                        if(!data.currentPrice) data.currentPrice = data.cost;
                        delete data.price;
                    } else {
                        data.fee = Number(data.fee);
                        data.tax = Number(data.tax);
                        data.netPL = Number(data.netPL);
                        data.roi = Number(data.roi);
                    }

                    if (modalMode.value === 'add') {
                        await addDoc(collection(window.db, colName), data);
                    } else {
                        await updateDoc(doc(window.db, colName, editingId.value), data);
                    }
                    showModal.value = false;
                };

                // ----------------- é‚è¼¯è¨ˆç®— -----------------
                const autoCalculate = () => {
                    const p = formData.value.price;
                    const v = formData.value.volume;
                    if(!p || !v) return;
                    
                    // ç°¡æ˜“è©¦ç®—ï¼šè²·è³£çš†é è¨­ 0.1425% (æ‰‹çºŒè²»)ï¼Œç¨… 0.3%
                    const fee = Math.floor(p * v * 0.001425); 
                    const tax = Math.floor(p * v * 0.003);
                    formData.value.fee = fee;
                    formData.value.tax = tax;
                    // å‡è¨­é€™æ˜¯è³£å‡ºç´€éŒ„ï¼Œæç›Š = ç¸½åƒ¹ - æ‰‹çºŒè²» - ç¨… - (æˆæœ¬ä¼°ç®—?? é€™è£¡éœ€è¦ç”¨æˆ¶æ‰‹å¡«æˆæœ¬ï¼Œæš«æ™‚ç°¡åŒ–ç‚ºæˆäº¤åƒ¹ç•¶ä½œç²åˆ©åŸºæº–)
                    // çœŸå¯¦æƒ…æ³ï¼šéœ€è¼¸å…¥ã€Œè²·å…¥æˆæœ¬ã€ï¼Œé€™è£¡å…ˆåšç°¡æ˜“é˜²å‘†
                    alert('æ³¨æ„ï¼šæç›Šè©¦ç®—éœ€è¦ã€ŒåŸå§‹è²·å…¥æˆæœ¬ã€ï¼Œè«‹æ‰‹å‹•èª¿æ•´ã€Œæ·¨æç›Šã€æ¬„ä½ã€‚ç›®å‰å·²å¹«æ‚¨å¡«å…¥æ‰‹çºŒè²»èˆ‡ç¨…ã€‚');
                };

                // ----------------- çœŸå¯¦è‚¡åƒ¹ä¸²æ¥ (Vercel API) -----------------
                const refreshPrices = async () => {
                    loadingPrices.value = true;
                    // æŠ“å‡ºæ‰€æœ‰ä¸é‡è¤‡çš„ä»£è™Ÿ
                    const symbols = [...new Set(holdings.value.map(h => h.code))];
                    if(symbols.length === 0) { loadingPrices.value = false; return; }

                    try {
                        // å‘¼å«æˆ‘å€‘è‡ªå·±æ¶è¨­åœ¨ Vercel çš„ API
                        const res = await fetch(`/api/quote?symbols=${symbols.join(',')}`);
                        const data = await res.json();
                        
                        // æ‰¹é‡æ›´æ–° Firestore (å¯¦å‹™ä¸Šå»ºè­°å¾Œç«¯åšï¼Œå‰ç«¯åšä¹Ÿè¡Œ)
                        const { updateDoc, doc } = window.firebaseOps;
                        
                        for (const stock of holdings.value) {
                            // å‡è¨­ API å›å‚³æ ¼å¼: { "2330": 1080.0, "2603": 185.0 }
                            // å°è‚¡ä»£è™Ÿè™•ç†ï¼šYahoo Finance éœ€åŠ  .TW
                            const key = stock.code.endsWith('.TW') ? stock.code : stock.code; 
                            // é€™è£¡ç°¡åŒ–åŒ¹é…é‚è¼¯ï¼Œçœ‹ API æ€éº¼å¯«
                            const newPrice = data[stock.code] || data[`${stock.code}.TW`];
                            
                            if (newPrice) {
                                await updateDoc(doc(window.db, "holdings", stock.id), {
                                    currentPrice: newPrice
                                });
                            }
                        }
                    } catch (e) {
                        console.error("è‚¡åƒ¹æ›´æ–°å¤±æ•—", e);
                        alert("è‚¡åƒ¹æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API éƒ¨ç½²ç‹€æ…‹");
                    }
                    loadingPrices.value = false;
                };

                // ----------------- æ ¼å¼åŒ– -----------------
                // (èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒï¼Œçœç•¥é‡è¤‡éƒ¨åˆ†ï¼Œä¿æŒå®Œæ•´æ€§)
                const formatCurrency = (v) => new Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD', minimumFractionDigits:0}).format(v || 0);
                const formatNumber = (v) => new Intl.NumberFormat('zh-TW').format(v || 0);
                const formatPercent = (v) => (v * 100).toFixed(2) + '%';
                const getColorClass = (v) => v > 0 ? 'text-up' : (v < 0 ? 'text-down' : 'text-gray-400');
                const getPriceColor = (s) => s.currentPrice > s.cost ? 'text-up' : (s.currentPrice < s.cost ? 'text-down' : 'text-white');
                const getTypeBadge = (t) => {
                    const m = {'ç¾è‚¡':'border-blue-800 text-blue-400', 'èè³‡':'border-orange-800 text-orange-400', 'æœŸè²¨':'border-red-800 text-red-400'};
                    return m[t] ? `bg-${m[t].split(' ')[0].replace('border-','')} ${m[t]}` : 'bg-gray-800 text-gray-300';
                };

                // è¨ˆç®—å±¬æ€§
                const calculateUnrealizedPL = (s) => (s.currentPrice * s.volume) - (s.cost * s.volume);
                const calculateUnrealizedRate = (s) => s.cost ? (s.currentPrice - s.cost) / s.cost : 0;
                
                const totalAssets = computed(() => holdings.value.reduce((a, b) => a + (b.currentPrice * b.volume), 0));
                const totalUnrealizedPL = computed(() => holdings.value.reduce((a, b) => a + calculateUnrealizedPL(b), 0));
                const totalUnrealizedPLRate = computed(() => {
                    const c = holdings.value.reduce((a, b) => a + (b.cost * b.volume), 0);
                    return c ? totalUnrealizedPL.value / c : 0;
                });
                const totalRealizedPL = computed(() => history.value.reduce((a, b) => a + b.netPL, 0));
                const annualROI = computed(() => totalRealizedPL.value / 5000000); // å‡è¨­æœ¬é‡‘

                onMounted(() => {
                    // ç­‰å¾… Firebase SDK è¼‰å…¥å¾ŒåŸ·è¡Œ
                    const checkFirebase = setInterval(() => {
                        if (window.firebaseOps) {
                            initFirebaseSync();
                            clearInterval(checkFirebase);
                        }
                    }, 100);
                    
                    setInterval(() => currentTime.value = new Date().toLocaleString('zh-TW', {hour12:false}), 1000);
                });

                return { 
                    currentTab, currentTime, holdings, history, totalAssets, totalUnrealizedPL, totalUnrealizedPLRate, totalRealizedPL, annualROI, 
                    showModal, modalMode, modalType, formData, types, loadingPrices,
                    openModal, editItem, deleteItem, saveData, autoCalculate, refreshPrices,
                    formatCurrency, formatNumber, formatPercent, getColorClass, getPriceColor, getTypeBadge, calculateUnrealizedPL, calculateUnrealizedRate 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>